<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NYC Playground Explorer</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="./node_modules/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="./node_modules/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="./node_modules/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --ink:#e6f1ff; --muted:#9bb0c9; --accent:#4fd1c5; --accent2:#9f7aea;
      --bad:#ff6b6b; --good:#38b000;
    }
    html,body{height:100%; margin:0; padding:0;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    
    /* Header */
    .header{
      background:var(--panel);
      border-bottom:1px solid #1f2733;
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:16px;
      box-shadow:0 2px 10px rgba(0,0,0,.3);
      z-index:1000;
      position:relative;
    }
    
    .header h1{
      font-size:clamp(18px,2.2vw,24px);
      margin:0;
      font-weight:800;
      letter-spacing:.2px;
    }
    
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    
    .controls select{
      background:#0e141d;
      border:1px solid #273143;
      color:var(--ink);
      padding:8px 12px;
      border-radius:8px;
      font-size:14px;
    }
    
    button{
      cursor:pointer;
      background:linear-gradient(180deg,var(--accent),#3bb4a9);
      color:#071019;
      border:0;
      border-radius:8px;
      padding:10px 16px;
      font-weight:700;
      font-size:14px;
      transition:transform 0.1s;
    }
    
    button:hover{transform:translateY(-1px);}
    button.secondary{background:#192230;color:var(--ink);border:1px solid #2a3547}
    button.danger{background:#6b2e2e;color:#ffdede;}
    
    .count{color:var(--muted);font-size:14px;margin-left:auto;}
    
    /* Map Container */
    .map-container{
      height:calc(100vh - 80px);
      position:relative;
    }
    
    #map{
      height:100%;
      width:100%;
    }
    
    /* Details Panel */
    .details-panel{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background:var(--panel);
      border-top:1px solid #1f2733;
      border-radius:16px 16px 0 0;
      box-shadow:0 -5px 20px rgba(0,0,0,.5);
      transform:translateY(100%);
      transition:transform 0.3s ease;
      z-index:1000;
      max-height:50vh;
      overflow-y:auto;
    }
    
    .details-panel.visible{
      transform:translateY(0);
    }
    
    .details-content{
      padding:20px;
    }
    
    .details-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:16px;
    }
    
    .close-details{
      background:none;
      border:none;
      color:var(--muted);
      font-size:24px;
      padding:0;
      cursor:pointer;
      line-height:1;
    }
    
    .playground-title{
      font-size:20px;
      font-weight:800;
      margin:0 0 4px 0;
    }
    
    .playground-location{
      color:var(--muted);
      margin:0 0 12px 0;
    }
    
    .chip{
      display:inline-block;
      margin-right:6px;
      margin-top:6px;
      padding:6px 10px;
      border-radius:12px;
      background:#101825;
      border:1px solid #223049;
      color:var(--muted);
      font-size:12px;
    }
    
    .chip.ok{color:#d9fcd9;border-color:#2e6b2e;background:#0d1a0d}
    .chip.no{color:#ffdede;border-color:#6b2e2e;background:#1a0d0d}
    
    .playground-actions{
      margin-top:16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    
    /* Custom Leaflet Styles */
    .leaflet-popup-content-wrapper{
      background:var(--panel);
      border:1px solid #1f2733;
      border-radius:12px;
      color:var(--ink);
    }
    
    .leaflet-popup-content{
      margin:12px;
      color:var(--ink);
    }
    
    .leaflet-popup-tip{
      background:var(--panel);
      border:1px solid #1f2733;
    }
    
    .popup-title{
      font-weight:700;
      margin:0 0 8px 0;
      font-size:16px;
    }
    
    .popup-location{
      color:var(--muted);
      font-size:13px;
      margin:0 0 8px 0;
    }
    
    .popup-chips{
      margin-top:8px;
    }
    
    .popup-chips .chip{
      font-size:10px;
      padding:4px 6px;
      margin:2px 4px 2px 0;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px){
      .header{
        padding:10px 16px;
      }
      .controls{
        width:100%;
        justify-content:space-between;
      }
      .map-container{
        height:calc(100vh - 70px);
      }
    }
    
    /* Loading indicator */
    .loading{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      color:var(--muted);
      font-size:16px;
      z-index:1001;
    }
  </style>
</head>
<body>
  <header class="header">
    <div>
      <h1>NYC Playground Explorer</h1>
    </div>
    
    <div class="controls">
      <select id="borough">
        <option value="All">All Boroughs</option>
        <option>Manhattan</option>
        <option>Brooklyn</option>
        <option>Queens</option>
        <option>Bronx</option>
        <option>Staten Island</option>
      </select>
      
      <select id="accessible">
        <option value="Any">Any Access</option>
        <option value="Yes">Accessible</option>
        <option value="Limited">Limited Access</option>
        <option value="No">Not Accessible</option>
      </select>
      
      <select id="sensory">
        <option value="Any">Any Sensory</option>
        <option value="Y">Sensory-Friendly</option>
        <option value="N">Not Sensory-Friendly</option>
      </select>
      
      <button id="applyFilters" class="secondary">Apply Filters</button>
      <button id="pickRandom">üé≤ Pick Random</button>
      <button id="findMe" class="secondary">üìç Near Me</button>
    </div>
    
    <div class="count" id="count">Loading...</div>
  </header>

  <div class="map-container">
    <div id="map"></div>
    <div class="loading" id="loading">Loading playground data...</div>
    
    <div class="details-panel" id="detailsPanel">
      <div class="details-content" id="detailsContent">
        <div class="details-header">
          <div>
            <h2 class="playground-title" id="detailsTitle">Select a playground</h2>
            <p class="playground-location" id="detailsLocation">Click on a marker to see details</p>
          </div>
          <button class="close-details" id="closeDetails">√ó</button>
        </div>
        
        <div id="detailsInfo">
          <!-- Playground details will be populated here -->
        </div>
        
        <div class="playground-actions" id="detailsActions">
          <!-- Action buttons will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Management Panel (initially hidden) -->
  <div style="position:fixed;top:90px;right:20px;z-index:1001;display:none;" id="managementPanel">
    <div style="background:var(--panel);border:1px solid #1f2733;border-radius:12px;padding:16px;box-shadow:0 5px 20px rgba(0,0,0,.5);min-width:200px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:1px solid #2a3547;padding-bottom:8px;">
        <h4 style="margin:0;color:var(--accent);">üîß Admin Panel</h4>
        <button id="adminClose" style="background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;">√ó</button>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--muted);font-size:12px;margin-bottom:4px;">Reviews</div>
        <button id="addReview" class="secondary">‚úèÔ∏è Add Review</button>
        <button id="manageReviews" class="secondary">üìù Manage Reviews</button>
        
        <div style="color:var(--muted);font-size:12px;margin:12px 0 4px;">Database</div>
        <button id="addFavorite" class="secondary">‚ù§Ô∏è Add to Favorites</button>
        <button id="viewFavorites" class="secondary">üìã View Favorites</button>
        <button id="exportData" class="secondary">üíæ Export Data</button>
        <button id="showStats" class="secondary">üìä Show Stats</button>
        
        <div style="border-top:1px solid #2a3547;margin-top:8px;padding-top:8px;">
          <button id="resetDatabase" class="danger">üóëÔ∏è Reset Database</button>
          <button id="adminLogout" class="danger" style="margin-top:4px;">üö™ Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;padding:20px;">
    <div style="background:var(--panel);border-radius:12px;max-width:600px;margin:50px auto;padding:24px;max-height:80vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="margin:0;">Add Playground Review</h3>
        <button id="closeReviewModal" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;">√ó</button>
      </div>
      
      <form id="reviewForm">
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Playground</label>
          <select id="reviewPlayground" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
            <option value="">Select a playground...</option>
          </select>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Title</label>
          <input type="text" id="reviewTitle" placeholder="Review title..." style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Rating</label>
          <div style="display:flex;gap:4px;">
            <button type="button" class="star-rating" data-rating="1">‚≠ê</button>
            <button type="button" class="star-rating" data-rating="2">‚≠ê</button>
            <button type="button" class="star-rating" data-rating="3">‚≠ê</button>
            <button type="button" class="star-rating" data-rating="4">‚≠ê</button>
            <button type="button" class="star-rating" data-rating="5">‚≠ê</button>
          </div>
          <input type="hidden" id="reviewRating" value="5">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Review Content</label>
          <textarea id="reviewContent" rows="4" placeholder="Write your review..." style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);resize:vertical;"></textarea>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Author</label>
          <input type="text" id="reviewAuthor" value="NYC Parks Team" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="reviewFeatured" style="margin:0;">
            <span style="color:var(--muted);">Featured Review</span>
          </label>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" id="cancelReview" class="secondary">Cancel</button>
          <button type="submit" id="saveReview">üíæ Save Review</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Leaflet and MarkerCluster via script tags -->
  <script src="./node_modules/leaflet/dist/leaflet.js"></script>
  <script src="./node_modules/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script type="module">
    import playgroundDB from './db.js';
    
    // Try to import admin config, fallback if not available
    let ADMIN_CONFIG = null;
    try {
      const adminModule = await import('./admin-config.js');
      ADMIN_CONFIG = adminModule.ADMIN_CONFIG;
      console.log('Admin config loaded');
    } catch (e) {
      console.log('Admin config not found - admin features disabled');
    }

    // Global state
    const state = {
      map: null,
      playgrounds: [],
      filteredPlaygrounds: [],
      markers: [],
      markerClusterGroup: null,
      currentPlayground: null,
      isAdminMode: false,
      adminAuthenticated: false
    };

    const qs = id => document.getElementById(id);

    // Admin authentication functions
    function checkAdminAuth() {
      if (!ADMIN_CONFIG) return false;
      return localStorage.getItem('playgroundAdminAuth') === 'authenticated';
    }

    function promptAdminLogin() {
      if (!ADMIN_CONFIG) {
        alert('Admin configuration not found. Admin features are disabled.');
        return false;
      }

      const password = prompt('üîê Enter admin password:');
      if (!password) return false;

      const inputHash = btoa(password);
      if (inputHash === ADMIN_CONFIG.passwordHash) {
        localStorage.setItem('playgroundAdminAuth', 'authenticated');
        localStorage.setItem('adminLastLogin', new Date().toISOString());
        state.adminAuthenticated = true;
        console.log('Admin authenticated successfully');
        return true;
      } else {
        alert('‚ùå Invalid password');
        return false;
      }
    }

    function logoutAdmin() {
      localStorage.removeItem('playgroundAdminAuth');
      localStorage.removeItem('adminLastLogin');
      state.adminAuthenticated = false;
      state.isAdminMode = false;
      hideAdminPanel();
      alert('üëã Admin logged out');
    }

    function toggleAdminMode() {
      if (!state.adminAuthenticated) {
        if (!promptAdminLogin()) return;
      }
      
      state.isAdminMode = !state.isAdminMode;
      if (state.isAdminMode) {
        showAdminPanel();
      } else {
        hideAdminPanel();
      }
    }

    function showAdminPanel() {
      qs('managementPanel').style.display = 'block';
      // Add admin badge to header
      if (!qs('adminBadge')) {
        const badge = document.createElement('div');
        badge.id = 'adminBadge';
        badge.innerHTML = 'üîß Admin Mode';
        badge.style.cssText = 'position:fixed;top:10px;right:10px;background:#6b2e2e;color:#ffdede;padding:8px 12px;border-radius:6px;font-size:12px;z-index:2000;';
        document.body.appendChild(badge);
      }
    }

    function hideAdminPanel() {
      qs('managementPanel').style.display = 'none';
      const badge = qs('adminBadge');
      if (badge) badge.remove();
    }

    // Review management functions
    async function loadPlaygroundReviews(propId) {
      try {
        const reviews = await playgroundDB.getReviewsForPlayground(propId);
        displayReviews(reviews);
      } catch (e) {
        console.warn('Could not load reviews:', e);
        qs('playgroundReviews').innerHTML = '<div style="color: var(--muted); font-size: 14px;">No reviews available</div>';
      }
    }

    function displayReviews(reviews) {
      const container = qs('playgroundReviews');
      if (!container) return;

      if (reviews.length === 0) {
        container.innerHTML = '<div style="color: var(--muted); font-size: 14px;">No reviews yet</div>';
        return;
      }

      const reviewsHtml = reviews.map(review => `
        <div style="border: 1px solid #2a3547; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #0e141d;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <h4 style="margin: 0; font-size: 16px; color: var(--ink);">${review.title}</h4>
            <div style="display: flex; gap: 2px;">
              ${'‚≠ê'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}
            </div>
          </div>
          <p style="margin: 0 0 8px 0; color: var(--ink); line-height: 1.4;">${review.content}</p>
          <div style="font-size: 12px; color: var(--muted);">
            By ${review.author} ‚Ä¢ ${new Date(review.date).toLocaleDateString()}
            ${review.featured ? ' ‚Ä¢ <span style="color: var(--accent);">‚≠ê Featured</span>' : ''}
          </div>
        </div>
      `).join('');

      container.innerHTML = `
        <div style="margin-bottom: 12px;">
          <h4 style="margin: 0; color: var(--accent);">üìù Reviews (${reviews.length})</h4>
        </div>
        ${reviewsHtml}
      `;
    }

    function populatePlaygroundSelect() {
      const select = qs('reviewPlayground');
      if (!select || !state.playgrounds) return;

      const sortedPlaygrounds = [...state.playgrounds].sort((a, b) => a.Name.localeCompare(b.Name));
      select.innerHTML = '<option value="">Select a playground...</option>' +
        sortedPlaygrounds.map(p => `<option value="${p.Prop_ID}">${p.Name} (${boroughFromPropId(p.Prop_ID)})</option>`).join('');
    }

    function showAddReviewModal() {
      populatePlaygroundSelect();
      
      // Pre-select current playground if available
      if (state.currentPlayground) {
        qs('reviewPlayground').value = state.currentPlayground.Prop_ID;
      }
      
      qs('reviewModal').style.display = 'block';
    }

    function hideAddReviewModal() {
      qs('reviewModal').style.display = 'none';
      qs('reviewForm').reset();
      qs('reviewRating').value = '5';
      updateStarDisplay(5);
    }

    function updateStarDisplay(rating) {
      const stars = document.querySelectorAll('.star-rating');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.opacity = '1';
          star.style.filter = 'grayscale(0)';
        } else {
          star.style.opacity = '0.3';
          star.style.filter = 'grayscale(1)';
        }
      });
    }

    async function saveReview() {
      const formData = {
        playground_prop_id: qs('reviewPlayground').value,
        title: qs('reviewTitle').value,
        content: qs('reviewContent').value,
        rating: parseInt(qs('reviewRating').value),
        author: qs('reviewAuthor').value,
        featured: qs('reviewFeatured').checked
      };

      // Validate form
      if (!formData.playground_prop_id) {
        alert('Please select a playground');
        return;
      }
      if (!formData.title || !formData.content) {
        alert('Please fill in title and content');
        return;
      }

      try {
        await playgroundDB.addReview(formData);
        hideAddReviewModal();
        
        // Refresh reviews if we're viewing the same playground
        if (state.currentPlayground && state.currentPlayground.Prop_ID === formData.playground_prop_id) {
          loadPlaygroundReviews(formData.playground_prop_id);
        }
        
        alert('‚úÖ Review saved successfully!');
      } catch (e) {
        console.error('Error saving review:', e);
        alert('‚ùå Error saving review: ' + e.message);
      }
    }

    async function showReviewManager() {
      try {
        const reviews = await playgroundDB.getAllReviews();
        let managerHtml = `
          <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;padding:20px;">
            <div style="background:var(--panel);border-radius:12px;max-width:800px;margin:50px auto;padding:24px;max-height:80vh;overflow-y:auto;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">üìù Review Manager (${reviews.length} reviews)</h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;">√ó</button>
              </div>
              <div style="max-height:60vh;overflow-y:auto;">
        `;

        if (reviews.length === 0) {
          managerHtml += '<div style="color:var(--muted);text-align:center;padding:40px;">No reviews found</div>';
        } else {
          managerHtml += reviews.map(review => {
            const playground = state.playgrounds.find(p => p.Prop_ID === review.playground_prop_id);
            const playgroundName = playground ? playground.Name : `Playground ${review.playground_prop_id}`;
            
            return `
              <div style="border:1px solid #2a3547;border-radius:8px;padding:12px;margin-bottom:12px;background:#0e141d;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                  <div>
                    <h4 style="margin:0;font-size:14px;">${review.title}</h4>
                    <div style="font-size:12px;color:var(--muted);">${playgroundName}</div>
                  </div>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <div style="display:flex;gap:1px;">${'‚≠ê'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}</div>
                    <button onclick="deleteReview(${review.id})" style="background:#6b2e2e;color:#ffdede;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px;">Delete</button>
                  </div>
                </div>
                <p style="margin:4px 0;font-size:12px;color:var(--ink);">${review.content.substring(0, 100)}${review.content.length > 100 ? '...' : ''}</p>
                <div style="font-size:11px;color:var(--muted);">
                  ${review.author} ‚Ä¢ ${new Date(review.date).toLocaleDateString()}
                  ${review.featured ? ' ‚Ä¢ <span style="color:var(--accent);">Featured</span>' : ''}
                </div>
              </div>
            `;
          }).join('');
        }

        managerHtml += `
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', managerHtml);
      } catch (e) {
        console.error('Error loading reviews:', e);
        alert('Error loading reviews: ' + e.message);
      }
    }

    window.deleteReview = async function(reviewId) {
      if (!confirm('Delete this review?')) return;
      
      try {
        await playgroundDB.deleteReview(reviewId);
        // Refresh the review manager
        document.querySelector('[style*="position:fixed"][style*="z-index:2000"]')?.remove();
        showReviewManager();
        
        // Refresh current playground reviews if applicable
        if (state.currentPlayground) {
          loadPlaygroundReviews(state.currentPlayground.Prop_ID);
        }
      } catch (e) {
        console.error('Error deleting review:', e);
        alert('Error deleting review: ' + e.message);
      }
    }

    // Initialize map
    function initMap() {
      // Create map centered on NYC
      state.map = L.map('map', {
        zoomControl: false
      }).setView([40.7589, -73.9851], 11);

      // Add zoom control to top right
      L.control.zoom({ position: 'topright' }).addTo(state.map);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(state.map);

      // Initialize marker cluster group
      state.markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
      });
      
      state.map.addLayer(state.markerClusterGroup);
    }

    // Create custom marker icons
    function createMarkerIcon(playground) {
      const access = normalizeAccessible(playground.Accessible);
      const sensory = (playground['Sensory-Friendly'] || '').toUpperCase();
      
      let color = '#dc2626'; // Default red
      if (access === 'Yes') color = '#38b000'; // Green for accessible
      else if (access === 'Limited') color = '#f59e0b'; // Yellow for limited
      
      // Different icon for sensory-friendly
      const icon = sensory === 'Y' ? 'üß∏' : 'üõù';
      
      return L.divIcon({
        html: `<div style="background-color: ${color}; border: 2px solid white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">${icon}</div>`,
        className: 'custom-marker',
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });
    }

    // Create popup content
    function createPopupContent(playground) {
      const borough = boroughFromPropId(playground.Prop_ID);
      const access = normalizeAccessible(playground.Accessible);
      const sensory = (playground['Sensory-Friendly'] || '').toUpperCase();
      
      return `
        <div class="popup-content">
          <div class="popup-title">${playground.Name}</div>
          <div class="popup-location">${playground.Location || ''}</div>
          <div class="popup-chips">
            <span class="chip">${borough}</span>
            <span class="chip ${access === 'Yes' ? 'ok' : 'no'}">‚ôø ${access}</span>
            <span class="chip ${sensory === 'Y' ? 'ok' : 'no'}">üë∂ ${sensory === 'Y' ? 'Sensory-Friendly' : 'Regular'}</span>
          </div>
          <div style="margin-top: 8px;">
            <button onclick="showPlaygroundDetails('${playground.Prop_ID}')" style="background: var(--accent); color: #071019; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">View Details</button>
          </div>
        </div>
      `;
    }

    // Add playground markers to map
    function addPlaygroundMarkers() {
      // Clear existing markers
      state.markerClusterGroup.clearLayers();
      state.markers = [];

      state.filteredPlaygrounds.forEach(playground => {
        const lat = parseFloat(playground.lat);
        const lon = parseFloat(playground.lon);
        
        if (isNaN(lat) || isNaN(lon)) return;

        const marker = L.marker([lat, lon], {
          icon: createMarkerIcon(playground)
        });

        marker.bindPopup(createPopupContent(playground));
        
        marker.on('click', () => {
          showPlaygroundDetails(playground.Prop_ID);
        });

        state.markers.push({ marker, playground });
        state.markerClusterGroup.addLayer(marker);
      });

      // Update count
      qs('count').textContent = `${state.filteredPlaygrounds.length} playgrounds`;
    }

    // Helper functions
    function boroughFromPropId(propId) {
      const map = {B:'Brooklyn', M:'Manhattan', Q:'Queens', X:'Bronx', R:'Staten Island'};
      return map[(propId||'')[0]] || 'Unknown';
    }

    function normalizeAccessible(value) {
      const val = String(value || '').toLowerCase();
      if (val.includes('yes') || val.includes('accessible')) return 'Yes';
      if (val.includes('no') || val.includes('not')) return 'No';
      if (val.includes('limited')) return 'Limited';
      return value || 'Unknown';
    }

    function normalizeLatLon(p) {
      let lat = parseFloat(p.lat), lon = parseFloat(p.lon);
      if (Math.abs(lat) > 90 || Math.abs(lon) < 90) { const t = lat; lat = lon; lon = t; }
      return {lat, lon};
    }

    // Show playground details in panel
    window.showPlaygroundDetails = function(propId) {
      const playground = state.playgrounds.find(p => p.Prop_ID === propId);
      if (!playground) return;

      state.currentPlayground = playground;
      const {lat, lon} = normalizeLatLon(playground);
      const borough = boroughFromPropId(playground.Prop_ID);
      const access = normalizeAccessible(playground.Accessible);
      const sensory = (playground['Sensory-Friendly'] || '').toUpperCase();
      const gmapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${lat},${lon} (${playground.Name})}`)}`;

      qs('detailsTitle').textContent = playground.Name;
      qs('detailsLocation').textContent = playground.Location || '';
      
      qs('detailsInfo').innerHTML = `
        <div style="margin-bottom: 16px;">
          <span class="chip">${borough}</span>
          <span class="chip ${access === 'Yes' ? 'ok' : 'no'}">‚ôø Accessible: ${access}</span>
          <span class="chip ${sensory === 'Y' ? 'ok' : 'no'}">üë∂ Sensory-Friendly: ${sensory || '?'}</span>
          <span class="chip">ID: ${playground.Playground_ID || playground.Prop_ID}</span>
        </div>
        <p style="margin: 0 0 16px 0;">
          <a href="${gmapLink}" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">üó∫Ô∏è Open in Google Maps ‚Üó</a>
        </p>
        <div id="playgroundReviews">
          <div style="color: var(--muted); font-size: 14px;">Loading reviews...</div>
        </div>
      `;

      // Load reviews for this playground
      loadPlaygroundReviews(playground.Prop_ID);

      qs('detailsActions').innerHTML = `
        <button id="favoriteBtn" class="secondary">‚ù§Ô∏è Add to Favorites</button>
        <button onclick="pickRandomPlayground()" class="secondary">üé≤ Another Random</button>
      `;

      updateFavoriteButton();
      qs('detailsPanel').classList.add('visible');
    };

    // Apply filters
    async function applyFilters() {
      const borough = qs('borough').value;
      const accessible = qs('accessible').value;
      const sensory = qs('sensory').value;

      try {
        const filters = {};
        if (borough !== 'All') filters.borough = borough;
        if (accessible !== 'Any') filters.accessible = accessible;
        if (sensory !== 'Any') filters.sensory = sensory;

        state.filteredPlaygrounds = await playgroundDB.filterPlaygrounds(filters);
      } catch (e) {
        console.warn('Database filtering failed, using client-side filtering:', e);
        // Fallback to client-side filtering
        let items = [...state.playgrounds];
        items = items.filter(p => {
          const pBorough = boroughFromPropId(p.Prop_ID);
          const pAccess = normalizeAccessible(p.Accessible);
          const pSens = (p['Sensory-Friendly']||'').toUpperCase();
          if (borough !== 'All' && pBorough !== borough) return false;
          if (accessible !== 'Any' && pAccess !== accessible) return false;
          if (sensory !== 'Any' && pSens !== sensory) return false;
          return true;
        });
        state.filteredPlaygrounds = items;
      }
      
      addPlaygroundMarkers();
    }

    // Pick random playground
    function pickRandomPlayground() {
      if (state.filteredPlaygrounds.length === 0) return;
      
      const random = state.filteredPlaygrounds[Math.floor(Math.random() * state.filteredPlaygrounds.length)];
      const {lat, lon} = normalizeLatLon(random);
      
      state.map.flyTo([lat, lon], 16);
      setTimeout(() => showPlaygroundDetails(random.Prop_ID), 500);
    }

    // Find user location
    function findNearMe() {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          state.map.flyTo([latitude, longitude], 14);
          
          // Add temporary marker for user location
          const userMarker = L.marker([latitude, longitude], {
            icon: L.divIcon({
              html: '<div style="background-color: #4fd1c5; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
              className: 'user-location-marker',
              iconSize: [20, 20],
              iconAnchor: [10, 10]
            })
          }).addTo(state.map);

          setTimeout(() => state.map.removeLayer(userMarker), 5000);
        },
        error => {
          alert('Unable to get your location. Please make sure location services are enabled.');
        }
      );
    }

    // Database management functions
    let currentPlayground = null;

    async function updateFavoriteButton() {
      if (state.currentPlayground && qs('favoriteBtn')) {
        const isFav = await playgroundDB.isFavorite(state.currentPlayground.id);
        qs('favoriteBtn').textContent = isFav ? 'üíî Remove from Favorites' : '‚ù§Ô∏è Add to Favorites';
      }
    }

    async function toggleFavorite() {
      if (!state.currentPlayground) return;
      
      try {
        const isFavorite = await playgroundDB.isFavorite(state.currentPlayground.id);
        if (isFavorite) {
          await playgroundDB.removeFromFavorites(state.currentPlayground.id);
        } else {
          await playgroundDB.addToFavorites(state.currentPlayground.id);
        }
        updateFavoriteButton();
      } catch (e) {
        console.error('Error managing favorites:', e);
      }
    }

    // Load and initialize
    async function load() {
      try {
        console.log('Starting load process...');
        
        // Initialize map first
        console.log('Initializing map...');
        initMap();
        console.log('Map initialized');
        
        // Load playground data
        console.log('Loading playground data from database...');
        try {
          state.playgrounds = await playgroundDB.getAllPlaygrounds();
          console.log('Got', state.playgrounds.length, 'playgrounds from database');
        } catch (dbError) {
          console.warn('Database access failed, will load from JSON:', dbError);
          state.playgrounds = [];
        }
        
        if (state.playgrounds.length === 0) {
          console.log('Database empty, loading from JSON...');
          qs('loading').textContent = 'Loading playground data from JSON...';
          
          try {
            const res = await fetch('./DPR_Playgrounds_001.json');
            console.log('JSON fetch response:', res.status);
            
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const data = await res.json();
            console.log('JSON data loaded, length:', data.length);
            const normalizedData = data.map(p => ({...p})).filter(p => p && p.Name);
            console.log('Normalized data length:', normalizedData.length);
            
            // If database fails, just use the JSON data directly
            try {
              console.log('Initializing database with JSON data...');
              await playgroundDB.initialize(normalizedData);
              state.playgrounds = await playgroundDB.getAllPlaygrounds();
              console.log('Database initialized, got', state.playgrounds.length, 'playgrounds');
            } catch (dbError) {
              console.warn('Database initialization failed, using JSON data directly:', dbError);
              state.playgrounds = normalizedData;
            }
          } catch (fetchError) {
            console.error('Failed to fetch JSON data:', fetchError);
            throw fetchError;
          }
        }
        
        state.filteredPlaygrounds = [...state.playgrounds];
        console.log('Adding markers to map...');
        addPlaygroundMarkers();
        
        qs('loading').style.display = 'none';
        qs('count').textContent = `${state.playgrounds.length} playgrounds loaded`;
        console.log('Load process completed successfully');
        
      } catch (e) {
        qs('loading').textContent = 'Error loading playground data: ' + e.message;
        console.error('Load error:', e);
      }
    }

    // Check for admin authentication on load
    if (checkAdminAuth()) {
      state.adminAuthenticated = true;
    }

    // Event listeners
    qs('applyFilters').addEventListener('click', applyFilters);
    qs('pickRandom').addEventListener('click', pickRandomPlayground);
    qs('findMe').addEventListener('click', findNearMe);
    qs('closeDetails').addEventListener('click', () => {
      qs('detailsPanel').classList.remove('visible');
    });

    // Admin panel event listeners
    qs('adminClose').addEventListener('click', () => toggleAdminMode());
    qs('adminLogout').addEventListener('click', () => logoutAdmin());
    qs('addReview').addEventListener('click', () => showAddReviewModal());
    qs('manageReviews').addEventListener('click', () => showReviewManager());

    // Review modal event listeners
    qs('closeReviewModal').addEventListener('click', hideAddReviewModal);
    qs('cancelReview').addEventListener('click', hideAddReviewModal);
    qs('saveReview').addEventListener('click', saveReview);

    // Star rating event listeners
    document.querySelectorAll('.star-rating').forEach(star => {
      star.addEventListener('click', (e) => {
        e.preventDefault();
        const rating = parseInt(e.target.dataset.rating);
        qs('reviewRating').value = rating;
        updateStarDisplay(rating);
      });
    });

    // Review form submission
    qs('reviewForm').addEventListener('submit', (e) => {
      e.preventDefault();
      saveReview();
    });

    // Keyboard shortcut for admin mode: Ctrl+Shift+A
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        e.preventDefault();
        toggleAdminMode();
      }
    });

    // Favorite button handler (delegated)
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'favoriteBtn') {
        toggleFavorite();
      }
    });

    // Initialize star display
    updateStarDisplay(5);

    // Load everything
    load();
  </script>
</body>
</html>