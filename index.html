<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NYC Playground Explorer</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="./node_modules/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="./node_modules/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="./node_modules/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  
  <style>
    :root{
      --bg: linear-gradient(135deg, #a8e6cf 0%, #dcedc8 50%, #f8f9fa 100%); 
      --panel: rgba(255, 255, 255, 0.95); 
      --ink: #2d3436; 
      --muted: #636e72; 
      --accent: #e17055; 
      --accent2: #fd79a8;
      --bad: #e84393; 
      --good: #00b894;
      --playground-blue: #74b9ff;
      --playground-yellow: #fdcb6e;
      --shadow: rgba(0, 0, 0, 0.1);
    }
    html,body{height:100%; margin:0; padding:0;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    
    /* Layout Structure */
    .app-container{
      display:flex;
      height:100vh;
    }
    
    /* Sidebar */
    .sidebar{
      width:33.333%;
      min-width:320px;
      max-width:400px;
      background:var(--panel);
      border-right:1px solid rgba(116, 185, 255, 0.3);
      display:flex;
      flex-direction:column;
      box-shadow:2px 0 20px var(--shadow);
      z-index:1000;
      overflow-y:auto;
      backdrop-filter: blur(10px);
    }
    
    .sidebar-header{
      padding:20px;
      border-bottom:1px solid rgba(116, 185, 255, 0.2);
      flex-shrink:0;
      background: linear-gradient(135deg, rgba(116, 185, 255, 0.1) 0%, rgba(253, 121, 168, 0.1) 100%);
    }
    
    .sidebar-header h1{
      font-size:clamp(20px,2.5vw,28px);
      margin:0 0 8px 0;
      font-weight:800;
      letter-spacing:.2px;
      background: linear-gradient(135deg, var(--playground-blue) 0%, var(--accent2) 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .sidebar-content{
      padding:20px;
      flex:1;
    }
    
    .controls{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    
    .control-group{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .control-group label{
      color:var(--muted);
      font-size:14px;
      font-weight:500;
    }
    
    .controls select{
      background: white;
      border:2px solid rgba(116, 185, 255, 0.3);
      color:var(--ink);
      padding:12px;
      border-radius:12px;
      font-size:14px;
      width:100%;
      box-shadow: 0 2px 10px var(--shadow);
      transition: all 0.2s ease;
    }
    
    .controls select:focus{
      border-color: var(--playground-blue);
      box-shadow: 0 2px 15px rgba(116, 185, 255, 0.3);
      outline: none;
    }
    
    .button-group{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }
    
    button{
      cursor:pointer;
      background:linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      color: white;
      border:0;
      border-radius:25px;
      padding:12px 20px;
      font-weight:600;
      font-size:14px;
      transition: all 0.2s ease;
      width:100%;
      box-shadow: 0 4px 15px rgba(225, 112, 85, 0.3);
    }
    
    button:hover{
      transform:translateY(-2px);
      box-shadow: 0 6px 20px rgba(225, 112, 85, 0.4);
    }
    button.secondary{
      background: white;
      color: var(--ink);
      border: 2px solid rgba(116, 185, 255, 0.3);
      box-shadow: 0 2px 10px var(--shadow);
    }
    button.secondary:hover{
      border-color: var(--playground-blue);
      box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
    }
    button.danger{
      background: linear-gradient(135deg, var(--bad) 0%, #fd79a8 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(232, 67, 147, 0.3);
    }
    
    .count{
      color:var(--muted);
      font-size:14px;
      text-align:center;
      padding:16px 20px;
      border-top:1px solid rgba(116, 185, 255, 0.2);
      background: linear-gradient(135deg, rgba(116, 185, 255, 0.05) 0%, rgba(253, 121, 168, 0.05) 100%);
      margin-top:auto;
      flex-shrink:0;
      backdrop-filter: blur(5px);
    }
    
    /* Fun checkbox styling */
    input[type="checkbox"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid var(--playground-blue);
      border-radius: 6px;
      position: relative;
      cursor: pointer;
      background: white;
      transition: all 0.2s ease;
    }
    
    input[type="checkbox"]:checked {
      background: linear-gradient(135deg, var(--playground-blue) 0%, var(--accent2) 100%);
      border-color: var(--playground-blue);
      transform: scale(1.1);
    }
    
    input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      color: white;
      font-size: 14px;
      font-weight: bold;
      top: -2px;
      left: 2px;
    }
    
    input[type="checkbox"]:hover {
      border-color: var(--accent2);
      box-shadow: 0 0 10px rgba(116, 185, 255, 0.3);
    }
    
    /* Map Container */
    .map-container{
      flex:1;
      position:relative;
    }
    
    #map{
      height:100%;
      width:100%;
    }
    
    /* Mobile Layout */
    @media (max-width: 768px) {
      .app-container{
        flex-direction:column;
      }
      
      .sidebar{
        width:100%;
        min-width:auto;
        max-width:none;
        height:auto;
        border-right:none;
        border-bottom:1px solid #1f2733;
      }
      
      .sidebar-header{
        padding:16px;
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
      }
      
      .sidebar-header h1{
        font-size:20px;
        margin:0;
      }
      
      .mobile-menu-toggle{
        background:none;
        border:none;
        cursor:pointer;
        display:none;
        padding:4px;
        border-radius:4px;
      }
      
      .hamburger{
        width:24px;
        height:18px;
        position:relative;
        display:flex;
        flex-direction:column;
        justify-content:space-between;
      }
      
      .hamburger span{
        width:100%;
        height:2px;
        background:var(--ink);
        border-radius:1px;
        transition:all 0.3s ease;
      }
      
      .hamburger.active span:nth-child(1){
        transform:rotate(45deg) translate(6px, 6px);
      }
      
      .hamburger.active span:nth-child(2){
        opacity:0;
      }
      
      .hamburger.active span:nth-child(3){
        transform:rotate(-45deg) translate(6px, -6px);
      }
      
      .sidebar-content{
        padding:16px;
        overflow:hidden;
        transition:max-height 0.3s ease-out;
      }
      
      .sidebar-content.collapsed{
        max-height:0;
        padding:0 16px;
      }
      
      .controls{
        gap:12px;
      }
      
      .button-group{
        flex-direction:row;
        flex-wrap:wrap;
      }
      
      @media (max-width: 768px) {        
        .mobile-menu-toggle{
          display:flex;
          justify-content: flex-end;
        }
        
        .sidebar-content.collapsed{
          max-height:0;
          padding:0 16px;
        }
        
        /* Smaller text for mobile controls */
        .control-group label{
          font-size:12px;
          margin-bottom:4px;
        }
        
        .controls select{
          padding:8px;
          font-size:12px;
          border-radius:6px;
        }
        
        .controls{
          gap:8px;
        }
        
        .control-group{
          gap:4px;
        }
        
        /* Smaller checkbox labels */
        .mobile-small{
          font-size:11px !important;
        }
        
        /* Bathroom options on same line for mobile */
        .bathroom-options{
          flex-direction:row !important;
          gap:12px !important;
        }
        
        /* Sprinkler options styling for mobile */
        .sprinkler-options{
          flex-direction:row !important;
          gap:12px !important;
        }
        
        /* Smaller buttons */
        .button-group button{
          padding:8px 12px;
          font-size:12px;
          font-weight:600;
        }
        
        .button-group{
          gap:6px;
          margin-top:12px;
        }
      }
    }
      
      .button-group button{
        flex:1;
        min-width:120px;
      }
    }
    
    /* Details Panel */
    .details-panel{
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background:var(--panel);
      border-top:1px solid #1f2733;
      border-radius:16px 16px 0 0;
      box-shadow:0 -5px 20px rgba(0,0,0,.5);
      transform:translateY(100%);
      transition:transform 0.3s ease;
      z-index:1000;
      max-height:50vh;
      overflow-y:auto;
    }
    
    .details-panel.visible{
      transform:translateY(0);
    }
    
    .details-content{
      padding:20px;
    }
    
    .details-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:16px;
    }
    
    .close-details{
      background:none;
      border:none;
      color:var(--muted);
      font-size:24px;
      padding:0;
      cursor:pointer;
      line-height:1;
    }
    
    .playground-title{
      font-size:20px;
      font-weight:800;
      margin:0 0 4px 0;
    }
    
    .playground-location{
      color:var(--muted);
      margin:0 0 12px 0;
    }
    
    .chip{
      display:inline-block;
      margin-right:6px;
      margin-top:6px;
      padding:6px 10px;
      border-radius:12px;
      background:#101825;
      border:1px solid #223049;
      color:var(--muted);
      font-size:12px;
    }
    
    .chip.ok{color:#d9fcd9;border-color:#2e6b2e;background:#0d1a0d}
    .chip.no{color:#ffdede;border-color:#6b2e2e;background:#1a0d0d}
    
    .playground-actions{
      margin-top:16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    
    /* Custom Leaflet Styles */
    .leaflet-popup-content-wrapper{
      background:var(--panel);
      border:1px solid #1f2733;
      border-radius:12px;
      color:var(--ink);
    }
    
    .leaflet-popup-content{
      margin:12px;
      color:var(--ink);
    }
    
    .leaflet-popup-tip{
      background:var(--panel);
      border:1px solid #1f2733;
    }
    
    .popup-title{
      font-weight:700;
      margin:0 0 8px 0;
      font-size:16px;
    }
    
    .popup-location{
      color:var(--muted);
      font-size:13px;
      margin:0 0 8px 0;
    }
    
    .popup-chips{
      margin-top:8px;
    }
    
    .popup-chips .chip{
      font-size:10px;
      padding:4px 6px;
      margin:2px 4px 2px 0;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px){
      .header{
        padding:10px 16px;
      }
      .controls{
        width:100%;
        justify-content:space-between;
      }
      .map-container{
        height:calc(100vh - 70px);
      }
    }
    
    /* Loading indicator */
    .loading{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      color:var(--muted);
      font-size:16px;
      z-index:1001;
    }
    
  </style>
</head>
<body>
  <div class="app-container">
    <div class="sidebar">
      <div class="sidebar-header">
        <div>
          <h1>NYC Playground Explorer</h1>
          <div style="font-size:12px;color:var(--muted);">
            Data sourced from NYC Parks Department. <br/>
            <a href="about.html" style="color:var(--accent);text-decoration:none;">About this project</a>
          </div>
        </div>
        <div class="mobile-menu-toggle" id="mobileMenuToggle">
          <div class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
      
      <div class="sidebar-content" id="sidebar-content">
        <div class="controls">
          <div id="playgroundCount" style="font-size: 14px; color: var(--ink); margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, var(--playground-yellow) 0%, var(--playground-blue) 100%); border-radius: 20px; text-align: center; border: none; box-shadow: 0 4px 15px rgba(116, 185, 255, 0.2); font-weight: 600;">
            🏗️ Loading playgrounds...
          </div>
          
          <div class="control-group">
            <label for="borough">Borough</label>
            <select id="borough">
              <option value="All">All Boroughs</option>
              <option>Manhattan</option>
              <option>Brooklyn</option>
              <option>Queens</option>
              <option>Bronx</option>
              <option>Staten Island</option>
            </select>
          </div>
          
          <div class="control-group">
            <label for="accessible">Accessibility</label>
            <select id="accessible">
              <option value="Any">Any Access</option>
              <option value="Yes">Accessible</option>
              <option value="Limited">Limited Access</option>
              <option value="No">Not Accessible</option>
            </select>
          </div>
          
          <div class="control-group">
            <label for="sensory">Sensory Features</label>
            <select id="sensory">
              <option value="Any">Any Sensory</option>
              <option value="Y">Sensory-Friendly</option>
              <option value="N">Not Sensory-Friendly</option>
            </select>
          </div>
          
          <div class="control-group">
            <label>Bathroom Options</label>
            <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 4px;" class="bathroom-options">
              <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;" class="mobile-small">
                <input type="checkbox" id="bathroomAny" style="margin: 0;">
                <span>Any Bathroom</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;" class="mobile-small">
                <input type="checkbox" id="bathroomAccessible" style="margin: 0;">
                <span>Accessible Bathroom</span>
              </label>
            </div>
          </div>
          
          <div class="control-group">
            <label>Sprinkler Options</label>
            <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 4px;" class="sprinkler-options">
              <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; cursor: pointer;" class="mobile-small">
                <input type="checkbox" id="sprinklerAny" style="margin: 0;">
                <span>💦 Has Sprinklers</span>
              </label>
            </div>
          </div>
          
          <div class="button-group">
            <button id="applyFilters" class="btn secondary">Apply Filters</button>
            <button id="pickRandom">🎲 Pick Random</button>
            <button id="findMe" class="secondary">📍 Near Me</button>
          </div>
        </div>
      </div>
      
      <div class="count" id="count">Loading...</div>
    </div>
    
    <div class="map-container">
    <div id="map"></div>
    <div class="loading" id="loading">Loading playground data...</div>
    
    <div class="details-panel" id="detailsPanel">
      <div class="details-content" id="detailsContent">
        <div class="details-header">
          <div>
            <h2 class="playground-title" id="detailsTitle">Select a playground</h2>
            <p class="playground-location" id="detailsLocation">Click on a marker to see details</p>
          </div>
          <button class="close-details" id="closeDetails">×</button>
        </div>
        
        <div id="detailsInfo">
          <!-- Playground details will be populated here -->
        </div>
        
        <div class="playground-actions" id="detailsActions">
          <!-- Action buttons will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Management Panel (initially hidden) -->
  <div style="position:fixed;top:90px;right:20px;z-index:1001;display:none;" id="managementPanel">
    <div style="background:var(--panel);border:1px solid #1f2733;border-radius:12px;padding:16px;box-shadow:0 5px 20px rgba(0,0,0,.5);min-width:200px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;border-bottom:1px solid #2a3547;padding-bottom:8px;">
        <h4 style="margin:0;color:var(--accent);">🔧 Admin Panel</h4>
        <button id="adminClose" style="background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;">×</button>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div style="color:var(--muted);font-size:12px;margin-bottom:4px;">Playgrounds</div>
        <button id="addPlayground" class="secondary">🏗️ Add Playground</button>
        <button id="managePlaygrounds" class="secondary">📍 Manage Playgrounds</button>
        <button id="editPlaygroundInfo" class="secondary">📝 Edit Playground Info</button>
        
        <div style="color:var(--muted);font-size:12px;margin:12px 0 4px;">Reviews</div>
        <button id="addReview" class="secondary">✏️ Add Review</button>
        <button id="manageReviews" class="secondary">📝 Manage Reviews</button>
        
        <div style="color:var(--muted);font-size:12px;margin:12px 0 4px;">Database</div>
        <button id="addFavorite" class="secondary">❤️ Add to Favorites</button>
        <button id="viewFavorites" class="secondary">📋 View Favorites</button>
        <button id="exportData" class="secondary">💾 Export Data</button>
        <button id="showStats" class="secondary">📊 Show Stats</button>
        
        <div style="border-top:1px solid #2a3547;margin-top:8px;padding-top:8px;">
          <button id="upgradeSchema" class="secondary">🔧 Upgrade Database Schema</button>
          <button id="resetDatabase" class="danger">🗑️ Reset Database</button>
          <button id="adminLogout" class="danger" style="margin-top:4px;">🚪 Logout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Modal -->
  <div id="reviewModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;padding:20px;">
    <div style="background:var(--panel);border-radius:12px;max-width:600px;margin:50px auto;padding:24px;max-height:80vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="margin:0;">Add Playground Review</h3>
        <button id="closeReviewModal" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;">×</button>
      </div>
      
      <form id="reviewForm">
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Playground</label>
          <select id="reviewPlayground" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
            <option value="">Select a playground...</option>
          </select>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Title</label>
          <input type="text" id="reviewTitle" placeholder="Review title..." style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Rating</label>
          <div style="display:flex;gap:4px;">
            <button type="button" class="star-rating" data-rating="1">⭐</button>
            <button type="button" class="star-rating" data-rating="2">⭐</button>
            <button type="button" class="star-rating" data-rating="3">⭐</button>
            <button type="button" class="star-rating" data-rating="4">⭐</button>
            <button type="button" class="star-rating" data-rating="5">⭐</button>
          </div>
          <input type="hidden" id="reviewRating" value="5">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Review Content</label>
          <textarea id="reviewContent" rows="4" placeholder="Write your review..." style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);resize:vertical;"></textarea>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Author</label>
          <input type="text" id="reviewAuthor" value="NYC Parks Team" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="reviewFeatured" style="margin:0;">
            <span style="color:var(--muted);">Featured Review</span>
          </label>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" id="cancelReview" class="secondary">Cancel</button>
          <button type="submit" id="saveReview">💾 Save Review</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Playground Modal -->
  <div id="playgroundModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;padding:20px;">
    <div style="background:var(--panel);border-radius:12px;max-width:700px;margin:30px auto;padding:24px;max-height:85vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="margin:0;" id="playgroundModalTitle">Add New Playground</h3>
        <button id="closePlaygroundModal" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;">×</button>
      </div>
      
      <form id="playgroundForm">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);">Property ID *</label>
            <input type="text" id="playgroundPropId" placeholder="e.g., M001, B042" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">Borough prefix: M(Manhattan), B(Brooklyn), Q(Queens), X(Bronx), R(Staten Island)</div>
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);">Playground ID</label>
            <input type="text" id="playgroundId" placeholder="Same as Property ID if blank" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
          </div>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Playground Name *</label>
          <input type="text" id="playgroundName" placeholder="Central Park Playground" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Location</label>
          <input type="text" id="playgroundLocation" placeholder="5th Ave & 72nd St" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);">Latitude *</label>
            <input type="number" step="any" id="playgroundLat" placeholder="40.7589" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">NYC range: 40.4 - 40.9</div>
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);">Longitude *</label>
            <input type="number" step="any" id="playgroundLon" placeholder="-73.9851" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
            <div style="font-size:11px;color:var(--muted);margin-top:4px;">NYC range: -74.3 to -73.7</div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px;">
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);">Wheelchair Accessible</label>
            <select id="playgroundAccessible" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
              <option value="Yes">Yes</option>
              <option value="Limited">Limited</option>
              <option value="No">No</option>
              <option value="Unknown">Unknown</option>
            </select>
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);">Sensory-Friendly</label>
            <select id="playgroundSensory" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
              <option value="Y">Yes</option>
              <option value="N">No</option>
              <option value="">Unknown</option>
            </select>
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;color:var(--muted);">ADA Restroom</label>
            <select id="playgroundRestroom" style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
              <option value="Accessible">Accessible</option>
              <option value="Not Accessible">Not Accessible</option>
              <option value="Unknown">Unknown</option>
            </select>
          </div>
        </div>
        
        <div style="margin-bottom:20px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Notes</label>
          <textarea id="playgroundNotes" rows="2" placeholder="Additional information about this playground..." style="width:100%;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);resize:vertical;"></textarea>
        </div>
        
        <div id="playgroundErrors" style="display:none;background:#6b2e2e;border:1px solid #a53e3e;border-radius:8px;padding:12px;margin-bottom:16px;">
          <div style="font-weight:bold;margin-bottom:8px;color:#ffdede;">⚠️ Please fix the following issues:</div>
          <ul id="playgroundErrorList" style="margin:0;padding-left:20px;color:#ffdede;"></ul>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:flex-end;">
          <button type="button" id="cancelPlayground" class="secondary">Cancel</button>
          <button type="button" id="savePlayground">💾 Save Playground</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Playgrounds Modal -->
  <div id="managePlaygroundsModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;padding:20px;">
    <div style="background:var(--panel);border-radius:12px;max-width:900px;margin:30px auto;padding:24px;max-height:85vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="margin:0;">📍 Playground Manager</h3>
        <button id="closeManagePlaygrounds" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;">×</button>
      </div>
      
      <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center;flex-wrap:wrap;">
        <input type="text" id="playgroundSearch" placeholder="Search playgrounds..." style="flex:1;min-width:200px;padding:10px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);">
        <button id="searchPlaygrounds" class="secondary">🔍 Search</button>
        <button id="clearSearch" class="secondary">Clear</button>
      </div>
      
      <div id="playgroundsList" style="max-height:60vh;overflow-y:auto;">
        <div style="color:var(--muted);text-align:center;padding:40px;">Click search or leave blank to show all playgrounds</div>
      </div>
    </div>
  </div>

  <!-- Near Me Modal -->
  <div id="nearMeModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;padding:20px;">
    <div style="background:var(--panel);border-radius:12px;max-width:500px;margin:50px auto;padding:24px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="margin:0;">📍 Find Playgrounds Near You</h3>
        <button id="closeNearMe" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;">×</button>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="display:block;margin-bottom:8px;color:var(--muted);">Address or Location</label>
        <input type="text" id="nearMeAddress" placeholder="Enter address, intersection, or landmark..." 
               style="width:100%;padding:12px;border:1px solid #273143;border-radius:8px;background:#0e141d;color:var(--ink);font-size:14px;">
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="useCurrentLocation" class="secondary" style="font-size:12px;padding:6px 12px;">📍 Use My Location</button>
          <button id="geocodeAddress" style="font-size:12px;padding:6px 12px;">🔍 Find Address</button>
        </div>
      </div>
      
      <div style="margin-bottom:24px;">
        <label style="display:block;margin-bottom:12px;color:var(--muted);">Distance Range</label>
        <div style="background:#0e141d;border:1px solid #273143;border-radius:8px;padding:16px;">
          <input type="range" id="distanceSlider" min="0" max="6" value="2" 
                 style="width:100%;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:8px;">
            <span>Close</span>
            <span id="distanceLabel">20 min walk</span>
            <span>Far</span>
          </div>
          <div style="font-size:11px;color:var(--muted);">
            <div>🚶‍♂️ Walk: 10min • 20min • 30min</div>
            <div>🚗 Drive: 1 mile • 2 miles • 3 miles • 5 miles</div>
          </div>
        </div>
      </div>
      
      <div style="display:flex;gap:12px;justify-content:flex-end;">
        <button id="cancelNearMe" class="secondary">Cancel</button>
        <button id="findNearbyPlaygrounds" disabled>🔍 Find Nearby Playgrounds</button>
      </div>
      
      <div id="nearMeResults" style="margin-top:16px;display:none;">
        <div style="border-top:1px solid #273143;padding-top:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <strong>Found <span id="nearbyCount">0</span> playgrounds</strong>
            <button id="showOnMap" class="secondary" style="font-size:12px;padding:4px 8px;">Show on Map</button>
          </div>
          <div id="nearbyList" style="max-height:200px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Playground Info Editor Modal -->
  <div id="playgroundInfoModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;padding:20px;">
    <div style="background:var(--panel);border-radius:12px;max-width:800px;margin:20px auto;padding:24px;max-height:90vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="margin:0;">📝 Edit Playground Information</h3>
        <button id="closePlaygroundInfo" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;">×</button>
      </div>
      
      <!-- Playground Selection -->
      <div style="margin-bottom:20px;padding:16px;border:1px solid #273143;border-radius:8px;background:#0e141d;">
        <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap;">
          <input type="text" id="playgroundInfoSearch" placeholder="Search playgrounds..." 
                 style="flex:1;min-width:200px;padding:8px 12px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);font-size:14px;">
          <button id="searchPlaygroundInfo" class="secondary" style="padding:8px 16px;font-size:14px;">🔍 Search</button>
        </div>
        <select id="playgroundInfoSelect" style="width:100%;padding:12px;border:1px solid #273143;border-radius:8px;background:#121821;color:var(--ink);font-size:14px;">
          <option value="">Select a playground to edit...</option>
        </select>
      </div>

      <!-- Info Form -->
      <form id="playgroundInfoForm" style="display:none;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
          <!-- Left Column -->
          <div>
            <h4 style="margin:0 0 12px 0;color:var(--accent);">Basic Info</h4>
            
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Age Range</label>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="number" id="ageRangeMin" placeholder="Min" min="0" max="18" 
                       style="flex:1;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <span style="color:var(--muted);">to</span>
                <input type="number" id="ageRangeMax" placeholder="Max" min="0" max="18" 
                       style="flex:1;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <span style="color:var(--muted);font-size:12px;">years</span>
              </div>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Star Rating</label>
              <select id="starRating" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="">Not rated</option>
                <option value="1">⭐ 1 star</option>
                <option value="2">⭐⭐ 2 stars</option>
                <option value="3">⭐⭐⭐ 3 stars</option>
                <option value="4">⭐⭐⭐⭐ 4 stars</option>
                <option value="5">⭐⭐⭐⭐⭐ 5 stars</option>
              </select>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Shade</label>
              <select id="shadeLevel" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="unknown">Unknown</option>
                <option value="none">No shade</option>
                <option value="partial">Partial shade</option>
                <option value="full">Full shade</option>
              </select>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Fenced</label>
              <select id="fencedStatus" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="unknown">Unknown</option>
                <option value="yes">Yes - fully fenced</option>
                <option value="partial">Partially fenced</option>
                <option value="no">No fence</option>
              </select>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Surface</label>
              <select id="surfaceType" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="unknown">Unknown</option>
                <option value="rubber">Rubber/Soft surface</option>
                <option value="mulch">Wood chips/Mulch</option>
                <option value="sand">Sand</option>
                <option value="grass">Grass</option>
                <option value="concrete">Concrete/Hard surface</option>
                <option value="mixed">Mixed surfaces</option>
              </select>
            </div>
          </div>

          <!-- Right Column -->
          <div>
            <h4 style="margin:0 0 12px 0;color:var(--accent);">Amenities</h4>
            
            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Water Play</label>
              <select id="waterPlay" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="unknown">Unknown</option>
                <option value="yes">Yes - water features</option>
                <option value="seasonal">Seasonal water play</option>
                <option value="no">No water play</option>
              </select>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Bathroom</label>
              <select id="bathroomAccess" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="unknown">Unknown</option>
                <option value="onsite">On-site bathroom</option>
                <option value="nearby">Nearby (within 2 blocks)</option>
                <option value="none">No nearby bathroom</option>
              </select>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Drinking Fountain</label>
              <select id="drinkingFountain" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="unknown">Unknown</option>
                <option value="yes">Yes - working fountain</option>
                <option value="broken">Present but broken</option>
                <option value="no">No drinking fountain</option>
              </select>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Seating</label>
              <select id="seatingAvailable" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="unknown">Unknown</option>
                <option value="plenty">Plenty of seating</option>
                <option value="some">Some benches</option>
                <option value="limited">Very limited seating</option>
                <option value="none">No seating</option>
              </select>
            </div>

            <div style="margin-bottom:16px;">
              <label style="display:block;margin-bottom:8px;color:var(--muted);">Typical Crowd Level</label>
              <select id="crowdLevel" style="width:100%;padding:8px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);">
                <option value="unknown">Unknown</option>
                <option value="quiet">Usually quiet</option>
                <option value="moderate">Moderately busy</option>
                <option value="busy">Usually busy</option>
                <option value="very_busy">Very crowded</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Full-width fields -->
        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Special Features / Novelty Items</label>
          <textarea id="noveltyNotes" placeholder="Describe any special or unique features..." 
                    style="width:100%;padding:12px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);font-family:inherit;resize:vertical;min-height:60px;"></textarea>
        </div>

        <div style="margin-bottom:16px;">
          <label style="display:block;margin-bottom:8px;color:var(--muted);">Editor Notes</label>
          <textarea id="editorNotes" placeholder="Internal notes, observations, updates needed..." 
                    style="width:100%;padding:12px;border:1px solid #273143;border-radius:6px;background:#121821;color:var(--ink);font-family:inherit;resize:vertical;min-height:60px;"></textarea>
        </div>

        <!-- Action buttons -->
        <div style="display:flex;gap:12px;justify-content:flex-end;border-top:1px solid #273143;padding-top:20px;">
          <button type="button" id="cancelPlaygroundInfo" class="secondary">Cancel</button>
          <button type="submit" id="savePlaygroundInfo">💾 Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Leaflet and MarkerCluster via script tags -->
  <script src="./node_modules/leaflet/dist/leaflet.js"></script>
  <script src="./node_modules/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script type="module">
    import playgroundDB from './db.js';
    
    // Try to import admin config, fallback if not available
    let ADMIN_CONFIG = null;
    try {
      const adminModule = await import('./admin-config.js');
      ADMIN_CONFIG = adminModule.ADMIN_CONFIG;
      console.log('Admin config loaded');
    } catch (e) {
      console.log('Admin config not found - admin features disabled');
    }

    // Global state
    const state = {
      map: null,
      playgrounds: [],
      filteredPlaygrounds: [],
      markers: [],
      markerClusterGroup: null,
      currentPlayground: null,
      isAdminMode: false,
      adminAuthenticated: false
    };

    const qs = id => document.getElementById(id);

    // Admin authentication functions
    function checkAdminAuth() {
      if (!ADMIN_CONFIG) return false;
      return localStorage.getItem('playgroundAdminAuth') === 'authenticated';
    }

    function promptAdminLogin() {
      if (!ADMIN_CONFIG) {
        alert('Admin configuration not found. Admin features are disabled.');
        return false;
      }

      const password = prompt('🔐 Enter admin password:');
      if (!password) return false;

      const inputHash = btoa(password);
      if (inputHash === ADMIN_CONFIG.passwordHash) {
        localStorage.setItem('playgroundAdminAuth', 'authenticated');
        localStorage.setItem('adminLastLogin', new Date().toISOString());
        state.adminAuthenticated = true;
        console.log('Admin authenticated successfully');
        return true;
      } else {
        alert('❌ Invalid password');
        return false;
      }
    }

    function logoutAdmin() {
      localStorage.removeItem('playgroundAdminAuth');
      localStorage.removeItem('adminLastLogin');
      state.adminAuthenticated = false;
      state.isAdminMode = false;
      hideAdminPanel();
      alert('👋 Admin logged out');
    }

    function toggleAdminMode() {
      if (!state.adminAuthenticated) {
        if (!promptAdminLogin()) return;
      }
      
      state.isAdminMode = !state.isAdminMode;
      if (state.isAdminMode) {
        showAdminPanel();
      } else {
        hideAdminPanel();
      }
    }

    function showAdminPanel() {
      qs('managementPanel').style.display = 'block';
      // Add admin badge to header
      if (!qs('adminBadge')) {
        const badge = document.createElement('div');
        badge.id = 'adminBadge';
        badge.innerHTML = '🔧 Admin Mode';
        badge.style.cssText = 'position:fixed;top:10px;right:10px;background:#6b2e2e;color:#ffdede;padding:8px 12px;border-radius:6px;font-size:12px;z-index:2000;';
        document.body.appendChild(badge);
      }
    }

    function hideAdminPanel() {
      qs('managementPanel').style.display = 'none';
      const badge = qs('adminBadge');
      if (badge) badge.remove();
    }

    // Review management functions
    async function loadPlaygroundReviews(propId) {
      try {
        const reviews = await playgroundDB.getReviewsForPlayground(propId);
        displayReviews(reviews);
      } catch (e) {
        console.warn('Could not load reviews:', e);
        qs('playgroundReviews').innerHTML = '<div style="color: var(--muted); font-size: 14px;">No reviews available</div>';
      }
    }

    function displayReviews(reviews) {
      const container = qs('playgroundReviews');
      if (!container) return;

      if (reviews.length === 0) {
        container.innerHTML = '<div style="color: var(--muted); font-size: 14px;">No reviews yet</div>';
        return;
      }

      const reviewsHtml = reviews.map(review => `
        <div style="border: 1px solid #2a3547; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #0e141d;">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <h4 style="margin: 0; font-size: 16px; color: var(--ink);">${review.title}</h4>
            <div style="display: flex; gap: 2px;">
              ${'⭐'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
            </div>
          </div>
          <p style="margin: 0 0 8px 0; color: var(--ink); line-height: 1.4;">${review.content}</p>
          <div style="font-size: 12px; color: var(--muted);">
            By ${review.author} • ${new Date(review.date).toLocaleDateString()}
            ${review.featured ? ' • <span style="color: var(--accent);">⭐ Featured</span>' : ''}
          </div>
        </div>
      `).join('');

      container.innerHTML = `
        <div style="margin-bottom: 12px;">
          <h4 style="margin: 0; color: var(--accent);">📝 Reviews (${reviews.length})</h4>
        </div>
        ${reviewsHtml}
      `;
    }

    function populatePlaygroundSelect() {
      const select = qs('reviewPlayground');
      if (!select || !state.playgrounds) return;

      const sortedPlaygrounds = [...state.playgrounds].sort((a, b) => a.Name.localeCompare(b.Name));
      select.innerHTML = '<option value="">Select a playground...</option>' +
        sortedPlaygrounds.map(p => `<option value="${p.Prop_ID}">${p.Name} (${boroughFromPropId(p.Prop_ID)})</option>`).join('');
    }

    function showAddReviewModal() {
      populatePlaygroundSelect();
      
      // Pre-select current playground if available
      if (state.currentPlayground) {
        qs('reviewPlayground').value = state.currentPlayground.Prop_ID;
      }
      
      qs('reviewModal').style.display = 'block';
    }

    function hideAddReviewModal() {
      qs('reviewModal').style.display = 'none';
      qs('reviewForm').reset();
      qs('reviewRating').value = '5';
      updateStarDisplay(5);
    }

    function updateStarDisplay(rating) {
      const stars = document.querySelectorAll('.star-rating');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.opacity = '1';
          star.style.filter = 'grayscale(0)';
        } else {
          star.style.opacity = '0.3';
          star.style.filter = 'grayscale(1)';
        }
      });
    }

    async function saveReview() {
      const formData = {
        playground_prop_id: qs('reviewPlayground').value,
        title: qs('reviewTitle').value,
        content: qs('reviewContent').value,
        rating: parseInt(qs('reviewRating').value),
        author: qs('reviewAuthor').value,
        featured: qs('reviewFeatured').checked
      };

      // Validate form
      if (!formData.playground_prop_id) {
        alert('Please select a playground');
        return;
      }
      if (!formData.title || !formData.content) {
        alert('Please fill in title and content');
        return;
      }

      try {
        await playgroundDB.addReview(formData);
        hideAddReviewModal();
        
        // Refresh reviews if we're viewing the same playground
        if (state.currentPlayground && state.currentPlayground.Prop_ID === formData.playground_prop_id) {
          loadPlaygroundReviews(formData.playground_prop_id);
        }
        
        alert('✅ Review saved successfully!');
      } catch (e) {
        console.error('Error saving review:', e);
        alert('❌ Error saving review: ' + e.message);
      }
    }

    async function showReviewManager() {
      try {
        const reviews = await playgroundDB.getAllReviews();
        let managerHtml = `
          <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:2000;padding:20px;">
            <div style="background:var(--panel);border-radius:12px;max-width:800px;margin:50px auto;padding:24px;max-height:80vh;overflow-y:auto;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 style="margin:0;">📝 Review Manager (${reviews.length} reviews)</h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px;">×</button>
              </div>
              <div style="max-height:60vh;overflow-y:auto;">
        `;

        if (reviews.length === 0) {
          managerHtml += '<div style="color:var(--muted);text-align:center;padding:40px;">No reviews found</div>';
        } else {
          managerHtml += reviews.map(review => {
            const playground = state.playgrounds.find(p => p.Prop_ID === review.playground_prop_id);
            const playgroundName = playground ? playground.Name : `Playground ${review.playground_prop_id}`;
            
            return `
              <div style="border:1px solid #2a3547;border-radius:8px;padding:12px;margin-bottom:12px;background:#0e141d;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                  <div>
                    <h4 style="margin:0;font-size:14px;">${review.title}</h4>
                    <div style="font-size:12px;color:var(--muted);">${playgroundName}</div>
                  </div>
                  <div style="display:flex;gap:8px;align-items:center;">
                    <div style="display:flex;gap:1px;">${'⭐'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</div>
                    <button onclick="deleteReview(${review.id})" style="background:#6b2e2e;color:#ffdede;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px;">Delete</button>
                  </div>
                </div>
                <p style="margin:4px 0;font-size:12px;color:var(--ink);">${review.content.substring(0, 100)}${review.content.length > 100 ? '...' : ''}</p>
                <div style="font-size:11px;color:var(--muted);">
                  ${review.author} • ${new Date(review.date).toLocaleDateString()}
                  ${review.featured ? ' • <span style="color:var(--accent);">Featured</span>' : ''}
                </div>
              </div>
            `;
          }).join('');
        }

        managerHtml += `
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', managerHtml);
      } catch (e) {
        console.error('Error loading reviews:', e);
        alert('Error loading reviews: ' + e.message);
      }
    }

    window.deleteReview = async function(reviewId) {
      if (!confirm('Delete this review?')) return;
      
      try {
        await playgroundDB.deleteReview(reviewId);
        // Refresh the review manager
        document.querySelector('[style*="position:fixed"][style*="z-index:2000"]')?.remove();
        showReviewManager();
        
        // Refresh current playground reviews if applicable
        if (state.currentPlayground) {
          loadPlaygroundReviews(state.currentPlayground.Prop_ID);
        }
      } catch (e) {
        console.error('Error deleting review:', e);
        alert('Error deleting review: ' + e.message);
      }
    }

    // Playground management functions
    let currentEditingPlayground = null;

    function showAddPlaygroundModal() {
      currentEditingPlayground = null;
      qs('playgroundModalTitle').textContent = 'Add New Playground';
      qs('savePlayground').textContent = '💾 Save Playground';
      qs('playgroundForm').reset();
      hidePlaygroundErrors();
      
      // Set default values
      qs('playgroundAccessible').value = 'Yes';
      qs('playgroundSensory').value = 'Y';
      qs('playgroundRestroom').value = 'Accessible';
      
      qs('playgroundModal').style.display = 'block';
    }

    function showEditPlaygroundModal(playground) {
      currentEditingPlayground = playground;
      qs('playgroundModalTitle').textContent = 'Edit Playground';
      qs('savePlayground').textContent = '💾 Update Playground';
      
      // Populate form with existing data
      qs('playgroundPropId').value = playground.Prop_ID || '';
      qs('playgroundId').value = playground.Playground_ID || '';
      qs('playgroundName').value = playground.Name || '';
      qs('playgroundLocation').value = playground.Location || '';
      qs('playgroundLat').value = playground.lat || '';
      qs('playgroundLon').value = playground.lon || '';
      qs('playgroundAccessible').value = playground.Accessible || 'Unknown';
      qs('playgroundSensory').value = playground['Sensory-Friendly'] || 'N';
      qs('playgroundRestroom').value = playground.ADA_Accessible_Comfort_Station || 'Unknown';
      qs('playgroundNotes').value = playground.notes || '';
      
      hidePlaygroundErrors();
      qs('playgroundModal').style.display = 'block';
    }

    function hidePlaygroundModal() {
      qs('playgroundModal').style.display = 'none';
      qs('playgroundForm').reset();
      currentEditingPlayground = null;
      hidePlaygroundErrors();
    }

    function showPlaygroundErrors(errors) {
      const errorList = qs('playgroundErrorList');
      errorList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
      qs('playgroundErrors').style.display = 'block';
    }

    function hidePlaygroundErrors() {
      qs('playgroundErrors').style.display = 'none';
    }

    async function savePlayground() {
      const formData = {
        Prop_ID: qs('playgroundPropId').value.trim().toUpperCase(),
        Playground_ID: qs('playgroundId').value.trim() || qs('playgroundPropId').value.trim().toUpperCase(),
        Name: qs('playgroundName').value.trim(),
        Location: qs('playgroundLocation').value.trim(),
        lat: qs('playgroundLat').value,
        lon: qs('playgroundLon').value,
        Accessible: qs('playgroundAccessible').value,
        'Sensory-Friendly': qs('playgroundSensory').value,
        ADA_Accessible_Comfort_Station: qs('playgroundRestroom').value,
        notes: qs('playgroundNotes').value.trim()
      };

      try {
        let errors = [];
        
        if (currentEditingPlayground) {
          // For editing, skip duplicate check if same playground
          if (formData.Prop_ID !== currentEditingPlayground.Prop_ID) {
            const existing = await playgroundDB.getPlaygroundByPropId(formData.Prop_ID);
            if (existing) {
              errors.push('A playground with this Property ID already exists');
            }
          }
          
          // Basic validation
          if (!formData.Prop_ID) errors.push('Property ID is required');
          if (!formData.Name) errors.push('Playground name is required');
          if (!formData.lat || !formData.lon) {
            errors.push('Latitude and longitude are required');
          } else {
            const lat = parseFloat(formData.lat);
            const lon = parseFloat(formData.lon);
            if (isNaN(lat) || lat < -90 || lat > 90) {
              errors.push('Invalid latitude (must be between -90 and 90)');
            }
            if (isNaN(lon) || lon < -180 || lon > 180) {
              errors.push('Invalid longitude (must be between -180 and 180)');
            }
            if (lat < 40.4 || lat > 40.9 || lon < -74.3 || lon > -73.7) {
              errors.push('Coordinates should be in NYC area (lat: 40.4-40.9, lon: -74.3 to -73.7)');
            }
          }
        } else {
          // For new playgrounds, use full validation
          errors = await playgroundDB.validatePlayground(formData);
        }

        if (errors.length > 0) {
          showPlaygroundErrors(errors);
          return;
        }

        if (currentEditingPlayground) {
          // Update existing playground
          await playgroundDB.updatePlayground(currentEditingPlayground.id, formData);
          alert('✅ Playground updated successfully!');
        } else {
          // Add new playground
          await playgroundDB.addPlayground(formData);
          alert('✅ Playground added successfully!');
        }

        hidePlaygroundModal();
        
        // Refresh the map and data
        await refreshPlaygroundData();
        
      } catch (e) {
        console.error('Error saving playground:', e);
        alert('❌ Error saving playground: ' + e.message);
      }
    }

    async function refreshPlaygroundData() {
      try {
        state.playgrounds = await playgroundDB.getAllPlaygrounds();
        state.filteredPlaygrounds = [...state.playgrounds];
        addPlaygroundMarkers();
        qs('count').textContent = `${state.playgrounds.length} playgrounds`;
      } catch (e) {
        console.error('Error refreshing playground data:', e);
      }
    }

    function showManagePlaygroundsModal() {
      qs('managePlaygroundsModal').style.display = 'block';
      qs('playgroundSearch').value = '';
      qs('playgroundsList').innerHTML = '<div style="color:var(--muted);text-align:center;padding:40px;">Click search or leave blank to show all playgrounds</div>';
    }

    function hideManagePlaygroundsModal() {
      qs('managePlaygroundsModal').style.display = 'none';
    }

    async function searchPlaygrounds() {
      const searchTerm = qs('playgroundSearch').value.trim();
      const listContainer = qs('playgroundsList');
      
      try {
        let playgrounds;
        if (searchTerm === '') {
          playgrounds = state.playgrounds;
        } else {
          playgrounds = await playgroundDB.searchPlaygroundsAdmin(searchTerm);
        }

        if (playgrounds.length === 0) {
          listContainer.innerHTML = '<div style="color:var(--muted);text-align:center;padding:40px;">No playgrounds found</div>';
          return;
        }

        const playgroundsHtml = playgrounds.map(playground => {
          const borough = boroughFromPropId(playground.Prop_ID);
          const access = normalizeAccessible(playground.Accessible);
          const sensory = (playground['Sensory-Friendly'] || '').toUpperCase();
          
          return `
            <div style="border:1px solid #2a3547;border-radius:8px;padding:12px;margin-bottom:12px;background:#0e141d;">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                <div>
                  <h4 style="margin:0;font-size:16px;color:var(--ink);">${playground.Name}</h4>
                  <div style="font-size:12px;color:var(--muted);margin-top:4px;">
                    ID: ${playground.Prop_ID} • ${borough}
                  </div>
                  <div style="font-size:12px;color:var(--muted);">
                    ${playground.Location || 'No location specified'}
                  </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button onclick="editPlayground('${playground.Prop_ID}')" style="background:var(--accent);color:#071019;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px;">Edit</button>
                  <button onclick="deletePlaygroundConfirm('${playground.Prop_ID}')" style="background:#6b2e2e;color:#ffdede;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px;">Delete</button>
                </div>
              </div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">
                <span class="chip ${access === 'Yes' ? 'ok' : 'no'}">♿ ${access}</span>
                <span class="chip ${sensory === 'Y' ? 'ok' : 'no'}">👶 ${sensory === 'Y' ? 'Sensory-Friendly' : 'Regular'}</span>
                <span class="chip">📍 ${playground.lat?.toFixed(4)}, ${playground.lon?.toFixed(4)}</span>
              </div>
            </div>
          `;
        }).join('');

        listContainer.innerHTML = `
          <div style="margin-bottom:12px;color:var(--muted);font-size:14px;">
            Found ${playgrounds.length} playground${playgrounds.length === 1 ? '' : 's'}
          </div>
          ${playgroundsHtml}
        `;

      } catch (e) {
        console.error('Error searching playgrounds:', e);
        listContainer.innerHTML = '<div style="color:var(--bad);text-align:center;padding:40px;">Error loading playgrounds</div>';
      }
    }

    async function clearPlaygroundSearch() {
      qs('playgroundSearch').value = '';
      await searchPlaygrounds();
    }

    window.editPlayground = async function(propId) {
      try {
        const playground = await playgroundDB.getPlaygroundByPropId(propId);
        if (!playground) {
          alert('Playground not found');
          return;
        }
        hideManagePlaygroundsModal();
        showEditPlaygroundModal(playground);
      } catch (e) {
        console.error('Error loading playground for edit:', e);
        alert('Error loading playground: ' + e.message);
      }
    };

    window.deletePlaygroundConfirm = async function(propId) {
      try {
        const playground = await playgroundDB.getPlaygroundByPropId(propId);
        if (!playground) {
          alert('Playground not found');
          return;
        }

        const reviewCount = (await playgroundDB.getReviewsForPlayground(propId)).length;
        let message = `Delete "${playground.Name}"?`;
        if (reviewCount > 0) {
          message += `\n\nThis will also delete ${reviewCount} associated review${reviewCount === 1 ? '' : 's'}.`;
        }
        message += '\n\nThis action cannot be undone.';

        if (!confirm(message)) return;

        await playgroundDB.deletePlayground(playground.id);
        alert('✅ Playground deleted successfully');
        
        // Refresh both the management interface and the map
        await searchPlaygrounds();
        await refreshPlaygroundData();

      } catch (e) {
        console.error('Error deleting playground:', e);
        alert('❌ Error deleting playground: ' + e.message);
      }
    };

    // Database management functions (favorites, export, stats)
    async function addToFavorites() {
      if (!state.currentPlayground) {
        alert('Please select a playground first!');
        return;
      }
      
      try {
        const isAlreadyFavorite = await playgroundDB.isFavorite(state.currentPlayground.id);
        if (isAlreadyFavorite) {
          await playgroundDB.removeFromFavorites(state.currentPlayground.id);
          alert(`${state.currentPlayground.Name} removed from favorites!`);
        } else {
          await playgroundDB.addToFavorites(state.currentPlayground.id);
          alert(`${state.currentPlayground.Name} added to favorites!`);
        }
        
        updateFavoriteButton();
      } catch (e) {
        console.error('Error managing favorites:', e);
        alert('Error managing favorites');
      }
    }

    async function viewFavorites() {
      try {
        const favorites = await playgroundDB.getFavorites();
        if (favorites.length === 0) {
          alert('No favorites yet! Click on playgrounds and add them to your favorites.');
          return;
        }
        
        const favoritesList = favorites.map(p => 
          `• ${p.Name} (${boroughFromPropId(p.Prop_ID)})`
        ).join('\n');
        
        alert(`Your Favorite Playgrounds (${favorites.length}):\n\n${favoritesList}`);
      } catch (e) {
        console.error('Error viewing favorites:', e);
        alert('Error loading favorites');
      }
    }

    async function exportData() {
      try {
        const playgroundData = await playgroundDB.getAllPlaygrounds();
        const reviewData = await playgroundDB.getAllReviews();
        
        const exportPackage = {
          metadata: {
            exportDate: new Date().toISOString(),
            source: "NYC Playground Explorer",
            dataAttribution: {
              originalSource: "NYC Department of Parks & Recreation",
              sourceUrl: "https://www.nycgovparks.org/facilities/playgrounds",
              note: "Original playground data courtesy of NYC Parks Department"
            },
            counts: {
              playgrounds: playgroundData.length,
              reviews: reviewData.length
            }
          },
          playgrounds: playgroundData,
          reviews: reviewData
        };
        
        const data = JSON.stringify(exportPackage, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `nyc_playground_data_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('✅ Data exported successfully with attribution!');
      } catch (e) {
        console.error('Error exporting data:', e);
        alert('Error exporting data');
      }
    }

    async function showStats() {
      try {
        const playgroundStats = await playgroundDB.getPlaygroundStats();
        const reviewStats = await playgroundDB.getReviewStats();
        const favorites = await playgroundDB.getFavorites();
        
        alert(`NYC Playground Database Statistics:
        
🏗️ Playgrounds: ${playgroundStats.total}
   ♿ Accessible: ${playgroundStats.accessible} (${playgroundStats.accessiblePercent}%)
   👶 Sensory-Friendly: ${playgroundStats.sensoryFriendly} (${playgroundStats.sensoryPercent}%)
   📝 With Reviews: ${playgroundStats.withReviews} (${playgroundStats.reviewedPercent}%)

📝 Reviews: ${reviewStats.total}
   ⭐ Average Rating: ${reviewStats.avgRating}/5
   🌟 Featured: ${reviewStats.featured}
   ✅ Approved: ${reviewStats.approved}

❤️ Your Favorites: ${favorites.length}

📊 Data sourced from NYC Parks Department`);
      } catch (e) {
        console.error('Error loading stats:', e);
        alert('Error loading statistics');
      }
    }

    async function upgradeSchema() {
      if (!confirm('🔧 This will upgrade all playground records to include new detailed information fields. This is safe and preserves all existing data. Continue?')) {
        return;
      }
      
      try {
        // Check if the method exists, if not use fallback
        let result;
        if (typeof playgroundDB.forceSchemaUpgrade === 'function') {
          result = await playgroundDB.forceSchemaUpgrade();
        } else {
          // Fallback manual upgrade
          console.log('Using fallback upgrade method...');
          result = await manualSchemaUpgrade();
        }
        alert(`✅ Database schema upgraded successfully!\n\nUpgraded: ${result.upgraded} playgrounds\nTotal: ${result.total} playgrounds\n\nAll playgrounds now have extended information fields available for manual editing.`);
        console.log('Schema upgrade completed:', result);
      } catch (e) {
        console.error('Error upgrading schema:', e);
        if (e.message.includes('forceSchemaUpgrade is not a function')) {
          alert('❌ Database module needs to be reloaded. Please refresh the page and try again.\n\nThis error occurs when new database methods are added but the browser is using the cached version.');
        } else {
          alert('Error upgrading database schema: ' + e.message);
        }
      }
    }

    // Manual schema upgrade fallback function
    async function manualSchemaUpgrade() {
      console.log('Starting manual schema upgrade...');
      
      const defaultInfo = {
        age_range_min: null,
        age_range_max: null,
        novelty_has: null,
        novelty_notes: null,
        shade: 'unknown',
        fenced: 'unknown',
        star: null,
        surface: 'unknown',
        water_play: 'unknown',
        bathroom: 'unknown',
        drinking_fountain: 'unknown',
        seating: 'unknown',
        crowd_level: 'unknown',
        accessibility_ada_paths: null,
        accessibility_adaptive_swings: null,
        accessibility_notes: null,
        stroller_friendly: 'unknown',
        transit_nearest_stop: null,
        transit_walk_minutes: null,
        safety_line_of_sight: 'unknown',
        maintenance: 'unknown',
        last_verified: null,
        sources: [],
        editor_notes: null,
        schema_version: 2
      };

      const playgrounds = await playgroundDB.getAllPlaygrounds();
      let updated = 0;

      for (const playground of playgrounds) {
        if (!playground.schema_version || playground.schema_version < 2) {
          // Update playground with new fields
          const updates = { ...defaultInfo };
          await playgroundDB.updatePlayground(playground.id, updates);
          updated++;
        }
      }

      console.log(`Manual upgrade completed: ${updated} playgrounds updated`);
      return { upgraded: updated, total: playgrounds.length };
    }

    // Test function for playground info (for development/testing)
    async function testPlaygroundInfo() {
      try {
        console.log('Testing playground info functionality...');
        const playgrounds = await playgroundDB.getAllPlaygrounds();
        if (playgrounds.length > 0) {
          const testPlayground = playgrounds[0];
          console.log('Sample playground before info update:', testPlayground);
          
          // Test updating playground info
          const updates = {
            shade: 'partial',
            fenced: 'yes',
            star: 4,
            surface: 'rubber',
            water_play: 'yes',
            bathroom: 'nearby',
            editor_notes: 'Test update from admin panel'
          };
          
          await playgroundDB.updatePlaygroundInfo(testPlayground.id, updates);
          const updatedPlayground = await playgroundDB.getPlaygroundWithInfo(testPlayground.Prop_ID);
          console.log('Sample playground after info update:', updatedPlayground);
          
          console.log('✅ Playground info functionality test completed successfully!');
          return true;
        } else {
          console.log('No playgrounds found for testing');
          return false;
        }
      } catch (e) {
        console.error('Error testing playground info:', e);
        return false;
      }
    }

    // Make test function available globally for console access
    window.testPlaygroundInfo = testPlaygroundInfo;

    // Playground Info Editor Functions
    let currentEditingPlaygroundInfo = null;

    function showPlaygroundInfoEditor() {
      qs('playgroundInfoModal').style.display = 'block';
      loadPlaygroundsForInfoEdit();
      resetInfoForm();
    }

    function hidePlaygroundInfoEditor() {
      qs('playgroundInfoModal').style.display = 'none';
      qs('playgroundInfoForm').style.display = 'none';
      currentEditingPlaygroundInfo = null;
      resetInfoForm();
    }

    async function loadPlaygroundsForInfoEdit() {
      try {
        const playgrounds = await playgroundDB.getAllPlaygrounds();
        const select = qs('playgroundInfoSelect');
        select.innerHTML = '<option value="">Select a playground to edit...</option>';
        
        playgrounds.forEach(playground => {
          const option = document.createElement('option');
          option.value = playground.id;
          option.textContent = `${playground.Name || 'Unnamed'} - ${playground.Location || 'No location'}`;
          select.appendChild(option);
        });
      } catch (e) {
        console.error('Error loading playgrounds for info edit:', e);
        alert('Error loading playgrounds. Please try again.');
      }
    }

    async function searchPlaygroundsForInfoEdit() {
      const searchTerm = qs('playgroundInfoSearch').value.trim().toLowerCase();
      if (!searchTerm) {
        loadPlaygroundsForInfoEdit();
        return;
      }

      try {
        const playgrounds = await playgroundDB.searchPlaygroundsAdmin(searchTerm);
        const select = qs('playgroundInfoSelect');
        select.innerHTML = '<option value="">Select a playground to edit...</option>';
        
        playgrounds.forEach(playground => {
          const option = document.createElement('option');
          option.value = playground.id;
          option.textContent = `${playground.Name || 'Unnamed'} - ${playground.Location || 'No location'}`;
          select.appendChild(option);
        });
      } catch (e) {
        console.error('Error searching playgrounds for info edit:', e);
        alert('Error searching playgrounds. Please try again.');
      }
    }

    async function selectPlaygroundForInfoEdit() {
      const playgroundId = qs('playgroundInfoSelect').value;
      if (!playgroundId) {
        qs('playgroundInfoForm').style.display = 'none';
        return;
      }

      try {
        const playground = await playgroundDB.getPlaygroundById(parseInt(playgroundId));
        if (!playground) {
          alert('Playground not found');
          return;
        }

        currentEditingPlaygroundInfo = playground;
        populateInfoForm(playground);
        qs('playgroundInfoForm').style.display = 'block';
      } catch (e) {
        console.error('Error loading playground info:', e);
        alert('Error loading playground information. Please try again.');
      }
    }

    function populateInfoForm(playground) {
      // Basic info
      qs('ageRangeMin').value = playground.age_range_min || '';
      qs('ageRangeMax').value = playground.age_range_max || '';
      qs('starRating').value = playground.star || '';
      qs('shadeLevel').value = playground.shade || 'unknown';
      qs('fencedStatus').value = playground.fenced || 'unknown';
      qs('surfaceType').value = playground.surface || 'unknown';

      // Amenities
      qs('waterPlay').value = playground.water_play || 'unknown';
      qs('bathroomAccess').value = playground.bathroom || 'unknown';
      qs('drinkingFountain').value = playground.drinking_fountain || 'unknown';
      qs('seatingAvailable').value = playground.seating || 'unknown';
      qs('crowdLevel').value = playground.crowd_level || 'unknown';

      // Notes
      qs('noveltyNotes').value = playground.novelty_notes || '';
      qs('editorNotes').value = playground.editor_notes || '';
    }

    function resetInfoForm() {
      qs('playgroundInfoForm').reset();
      qs('playgroundInfoSelect').value = '';
      qs('playgroundInfoSearch').value = '';
    }

    async function savePlaygroundInfo(event) {
      event.preventDefault();
      
      if (!currentEditingPlaygroundInfo) {
        alert('No playground selected for editing');
        return;
      }

      const updates = {
        age_range_min: qs('ageRangeMin').value ? parseInt(qs('ageRangeMin').value) : null,
        age_range_max: qs('ageRangeMax').value ? parseInt(qs('ageRangeMax').value) : null,
        star: qs('starRating').value ? parseInt(qs('starRating').value) : null,
        shade: qs('shadeLevel').value,
        fenced: qs('fencedStatus').value,
        surface: qs('surfaceType').value,
        water_play: qs('waterPlay').value,
        bathroom: qs('bathroomAccess').value,
        drinking_fountain: qs('drinkingFountain').value,
        seating: qs('seatingAvailable').value,
        crowd_level: qs('crowdLevel').value,
        novelty_notes: qs('noveltyNotes').value.trim() || null,
        editor_notes: qs('editorNotes').value.trim() || null
      };

      try {
        // Use updatePlaygroundInfo if available, otherwise use updatePlayground
        if (typeof playgroundDB.updatePlaygroundInfo === 'function') {
          await playgroundDB.updatePlaygroundInfo(currentEditingPlaygroundInfo.id, updates);
        } else {
          // Fallback to basic update method
          await playgroundDB.updatePlayground(currentEditingPlaygroundInfo.id, {
            ...updates,
            last_verified: new Date().toISOString(),
            schema_version: 2
          });
        }

        alert('✅ Playground information updated successfully!');
        hidePlaygroundInfoEditor();
        
        // Refresh playground data
        await refreshPlaygroundData();
      } catch (e) {
        console.error('Error saving playground info:', e);
        alert('Error saving playground information: ' + e.message);
      }
    }

    async function resetDatabase() {
      if (!confirm('⚠️ This will delete ALL playground data and reviews from your browser. Are you sure?')) {
        return;
      }
      
      try {
        await playgroundDB.resetDatabase();
        alert('✅ Database reset successfully! The page will reload to import fresh data.');
        location.reload();
      } catch (e) {
        console.error('Error resetting database:', e);
        alert('Error resetting database. Try refreshing the page.');
      }
    }

    // Initialize map
    function initMap() {
      // Create map centered on NYC
      state.map = L.map('map', {
        zoomControl: false
      }).setView([40.760994, -73.928880], 12);

      // Add zoom control to top right
      L.control.zoom({ position: 'topright' }).addTo(state.map);

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(state.map);

      // Initialize marker cluster group
      state.markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 80,           // Larger radius for fewer clusters
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        disableClusteringAtZoom: 12     // Stop clustering at zoom 12 and above (more zoomed in)
      });
      
      state.map.addLayer(state.markerClusterGroup);
    }

    // Create custom marker icons
    function createMarkerIcon(playground) {
      const access = normalizeAccessible(playground.Accessible);
      const sensory = (playground['Sensory-Friendly'] || '').toUpperCase();
      
      let color = '#dc2626'; // Default red
      if (access === 'Yes') color = '#38b000'; // Green for accessible
      else if (access === 'Limited') color = '#f59e0b'; // Yellow for limited
      
      // Add slight border for sensory-friendly playgrounds
      const borderStyle = sensory === 'Y' ? 'border: 2px solid #9f7aea;' : 'border: 1px solid white;';
      
      return L.divIcon({
        html: `<div style="background-color: ${color}; ${borderStyle} border-radius: 50%; width: 8px; height: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>`,
        className: 'custom-marker',
        iconSize: [8, 8],
        iconAnchor: [4, 4]
      });
    }

    // Create popup content
    function createPopupContent(playground) {
      const borough = boroughFromPropId(playground.Prop_ID);
      const access = normalizeAccessible(playground.Accessible);
      const sensory = (playground['Sensory-Friendly'] || '').toUpperCase();
      
      return `
        <div class="popup-content">
          <div class="popup-title">${playground.Name}</div>
          <div class="popup-location">${playground.Location || ''}</div>
          <div class="popup-chips">
            <span class="chip">${borough}</span>
            <span class="chip ${access === 'Yes' ? 'ok' : 'no'}">♿ ${access}</span>
            <span class="chip ${sensory === 'Y' ? 'ok' : 'no'}">👶 ${sensory === 'Y' ? 'Sensory-Friendly' : 'Regular'}</span>
          </div>
          <div style="margin-top: 8px;">
            <button onclick="showPlaygroundDetails('${playground.Playground_ID}')" style="background: var(--accent); color: #071019; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">View Details</button>
          </div>
        </div>
      `;
    }

    // Add playground markers to map
    function addPlaygroundMarkers() {
      // Clear existing markers
      state.markerClusterGroup.clearLayers();
      state.markers = [];

      // Update playground count display
      const countEl = qs('playgroundCount');
      if (countEl) {
        const total = state.playgrounds.length;
        const filtered = state.filteredPlaygrounds.length;
        if (filtered === total) {
          countEl.textContent = `🎮 Showing all ${total} playgrounds`;
        } else {
          countEl.textContent = `🎯 Showing ${filtered} of ${total} playgrounds`;
        }
      }

      state.filteredPlaygrounds.forEach(playground => {
        const lat = parseFloat(playground.lat);
        const lon = parseFloat(playground.lon);
        
        if (isNaN(lat) || isNaN(lon)) return;

        const marker = L.marker([lat, lon], {
          icon: createMarkerIcon(playground)
        });

        marker.bindPopup(createPopupContent(playground));
        
        marker.on('click', () => {
          showPlaygroundDetails(playground.Playground_ID);
        });

        state.markers.push({ marker, playground });
        state.markerClusterGroup.addLayer(marker);
      });

      // Update count
      qs('count').textContent = `${state.filteredPlaygrounds.length} playgrounds`;
    }

    // Helper functions
    function boroughFromPropId(propId) {
      const map = {B:'Brooklyn', M:'Manhattan', Q:'Queens', X:'Bronx', R:'Staten Island'};
      return map[(propId||'')[0]] || 'Unknown';
    }

    function normalizeAccessible(value) {
      const val = String(value || '').toLowerCase();
      if (val.includes('yes') || val.includes('accessible')) return 'Yes';
      if (val.includes('no') || val.includes('not')) return 'No';
      if (val.includes('limited')) return 'Limited';
      return value || 'Unknown';
    }

    function normalizeLatLon(p) {
      let lat = parseFloat(p.lat), lon = parseFloat(p.lon);
      // Fix coordinate swap logic - NYC coordinates are roughly lat:40.7, lon:-74
      if (Math.abs(lat) > 90 || Math.abs(lon) > 180) { 
        const t = lat; lat = lon; lon = t; 
      }
      return {lat, lon};
    }

    // Show playground details in panel
    window.showPlaygroundDetails = function(playgroundId) {
      const playground = state.playgrounds.find(p => p.Playground_ID === playgroundId);
      if (!playground) return;

      state.currentPlayground = playground;
      const {lat, lon} = normalizeLatLon(playground);
      const borough = boroughFromPropId(playground.Prop_ID);
      const access = normalizeAccessible(playground.Accessible);
      const sensory = (playground['Sensory-Friendly'] || '').toUpperCase();
      const gmapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(`${lat},${lon} (${playground.Name})}`)}`;

      qs('detailsTitle').textContent = playground.Name;
      qs('detailsLocation').textContent = playground.Location || '';
      
      // Build extended info HTML
      let extendedInfoHTML = buildExtendedInfoHTML(playground);
      
      qs('detailsInfo').innerHTML = `
        <div style="margin-bottom: 16px;">
          <span class="chip">${borough}</span>
          <span class="chip ${access === 'Yes' ? 'ok' : 'no'}">♿ Accessible: ${access}</span>
          <span class="chip ${sensory === 'Y' ? 'ok' : 'no'}">👶 Sensory-Friendly: ${sensory || '?'}</span>
          <span class="chip">ID: ${playground.Playground_ID || playground.Prop_ID}</span>
        </div>
        ${extendedInfoHTML}
        <p style="margin: 0 0 16px 0;">
          <a href="${gmapLink}" target="_blank" rel="noopener" style="color: var(--accent); text-decoration: none;">🗺️ Open in Google Maps ↗</a>
        </p>
        <div id="playgroundReviews">
          <div style="color: var(--muted); font-size: 14px;">Loading reviews...</div>
        </div>
      `;

      // Load reviews for this playground
      loadPlaygroundReviews(playground.Prop_ID);

      qs('detailsActions').innerHTML = `
        <button id="favoriteBtn" class="secondary">❤️ Add to Favorites</button>
        <button onclick="pickRandomPlayground()" class="secondary">🎲 Another Random</button>
      `;

      updateFavoriteButton();
      qs('detailsPanel').classList.add('visible');
    };

    // Apply filters
    async function applyFilters() {
      const borough = qs('borough').value;
      const accessible = qs('accessible').value;
      const sensory = qs('sensory').value;
      const bathroomAny = qs('bathroomAny').checked;
      const bathroomAccessible = qs('bathroomAccessible').checked;
      const sprinklerAny = qs('sprinklerAny').checked;

      try {
        const filters = {};
        if (borough !== 'All') filters.borough = borough;
        if (accessible !== 'Any') filters.accessible = accessible;
        if (sensory !== 'Any') filters.sensory = sensory;
        if (bathroomAny || bathroomAccessible) {
          filters.bathroom = { any: bathroomAny, accessible: bathroomAccessible };
        }
        if (sprinklerAny) {
          filters.sprinkler = true;
          console.log('Sprinkler filter applied');
        }

        state.filteredPlaygrounds = await playgroundDB.filterPlaygrounds(filters);
        console.log(`Database filtering returned ${state.filteredPlaygrounds.length} playgrounds`);
      } catch (e) {
        console.warn('Database filtering failed, using client-side filtering:', e);
        // Fallback to client-side filtering
        console.log('Using client-side filtering fallback');
        let items = [...state.playgrounds];
        items = items.filter(p => {
          const pBorough = boroughFromPropId(p.Prop_ID);
          const pAccess = normalizeAccessible(p.Accessible);
          const pSens = (p['Sensory-Friendly']||'').toUpperCase();
          const pBathroom = (p['ADA_Accessible_Comfort_Station']||'').trim();
          if (borough !== 'All' && pBorough !== borough) return false;
          if (accessible !== 'Any' && pAccess !== accessible) return false;
          if (sensory !== 'Any' && pSens !== sensory) return false;
          
          // Handle bathroom checkboxes
          if (bathroomAny || bathroomAccessible) {
            let bathroomMatch = false;
            if (bathroomAny && (pBathroom === 'Not Accessible' || pBathroom === 'Accessible')) {
              bathroomMatch = true; // Has any bathroom (accessible or not)
            }
            if (bathroomAccessible && pBathroom === 'Accessible') {
              bathroomMatch = true; // Has accessible bathroom
            }
            if (!bathroomMatch) return false;
          }
          
          // Handle sprinkler checkbox
          if (sprinklerAny) {
            console.log('Checking sprinkler for:', p.Name, 'has_sprinkler:', p.has_sprinkler);
            const hasSprinkler = p.has_sprinkler === true;
            if (!hasSprinkler) return false;
          }
          
          return true;
        });
        state.filteredPlaygrounds = items;
      }
      
      addPlaygroundMarkers();
    }

    // Build extended playground information HTML (only show if data exists)
    function buildExtendedInfoHTML(playground) {
      let sections = [];
      
      // Helper function to check if a value is meaningful (not null, undefined, empty, or "unknown")
      const hasValue = (val) => val !== null && val !== undefined && val !== '' && val !== 'unknown';
      
      // Helper function to format display values
      const formatValue = (val) => {
        if (val === 'yes') return 'Yes';
        if (val === 'no') return 'No';
        if (val === 'partial') return 'Partial';
        return val;
      };

      // Basic Info Section
      let basicInfo = [];
      
      // Age Range
      if (hasValue(playground.age_range_min) || hasValue(playground.age_range_max)) {
        let ageText = '👶 Ages: ';
        if (hasValue(playground.age_range_min) && hasValue(playground.age_range_max)) {
          ageText += `${playground.age_range_min}-${playground.age_range_max} years`;
        } else if (hasValue(playground.age_range_min)) {
          ageText += `${playground.age_range_min}+ years`;
        } else if (hasValue(playground.age_range_max)) {
          ageText += `up to ${playground.age_range_max} years`;
        }
        basicInfo.push(ageText);
      }

      // Star Rating
      if (hasValue(playground.star)) {
        const stars = '⭐'.repeat(playground.star);
        basicInfo.push(`${stars} ${playground.star}/5`);
      }

      // Surface
      if (hasValue(playground.surface)) {
        const surfaceMap = {
          'rubber': '🛡️ Rubber surface',
          'mulch': '🌿 Wood chips',
          'sand': '🏖️ Sand',
          'grass': '🌱 Grass',
          'concrete': '🏗️ Hard surface',
          'mixed': '🔄 Mixed surfaces'
        };
        basicInfo.push(surfaceMap[playground.surface] || `🏗️ ${formatValue(playground.surface)} surface`);
      }

      if (basicInfo.length > 0) {
        sections.push(`
          <div style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; color: var(--accent); font-size: 14px;">Playground Info</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${basicInfo.map(info => `<span class="chip">${info}</span>`).join('')}
            </div>
          </div>
        `);
      }

      // Features Section
      let features = [];
      
      if (hasValue(playground.shade)) {
        const shadeMap = {
          'none': '☀️ No shade',
          'partial': '⛅ Some shade',
          'full': '🌳 Good shade'
        };
        features.push(shadeMap[playground.shade] || `🌳 ${formatValue(playground.shade)} shade`);
      }

      if (hasValue(playground.fenced)) {
        const fenceMap = {
          'yes': '🚪 Fully fenced',
          'partial': '🚧 Partially fenced',
          'no': '🔓 Not fenced'
        };
        features.push(fenceMap[playground.fenced] || `🚪 ${formatValue(playground.fenced)} fenced`);
      }

      if (hasValue(playground.water_play)) {
        const waterMap = {
          'yes': '💦 Water play',
          'seasonal': '🌊 Seasonal water',
          'no': ''  // Don't show if no water play
        };
        if (waterMap[playground.water_play]) {
          features.push(waterMap[playground.water_play]);
        }
      }

      if (features.length > 0) {
        sections.push(`
          <div style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; color: var(--accent); font-size: 14px;">Features</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${features.map(feature => `<span class="chip ok">${feature}</span>`).join('')}
            </div>
          </div>
        `);
      }

      // Amenities Section
      let amenities = [];

      if (hasValue(playground.bathroom)) {
        const bathroomMap = {
          'onsite': '🚻 Bathroom on-site',
          'nearby': '🚻 Bathroom nearby',
          'none': ''  // Don't show if no bathroom
        };
        if (bathroomMap[playground.bathroom]) {
          amenities.push(bathroomMap[playground.bathroom]);
        }
      }

      if (hasValue(playground.drinking_fountain)) {
        const fountainMap = {
          'yes': '🚰 Drinking fountain',
          'broken': '🚰 Fountain (broken)',
          'no': ''  // Don't show if no fountain
        };
        if (fountainMap[playground.drinking_fountain]) {
          amenities.push(fountainMap[playground.drinking_fountain]);
        }
      }

      if (hasValue(playground.seating)) {
        const seatingMap = {
          'plenty': '🪑 Plenty of seating',
          'some': '🪑 Some benches',
          'limited': '🪑 Limited seating',
          'none': ''  // Don't show if no seating
        };
        if (seatingMap[playground.seating]) {
          amenities.push(seatingMap[playground.seating]);
        }
      }

      if (amenities.length > 0) {
        sections.push(`
          <div style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; color: var(--accent); font-size: 14px;">Amenities</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${amenities.map(amenity => `<span class="chip">${amenity}</span>`).join('')}
            </div>
          </div>
        `);
      }

      // Crowd Level
      if (hasValue(playground.crowd_level)) {
        const crowdMap = {
          'quiet': '😌 Usually quiet',
          'moderate': '👥 Moderately busy',
          'busy': '👥👥 Usually busy',
          'very_busy': '👥👥👥 Very crowded'
        };
        const crowdInfo = crowdMap[playground.crowd_level] || `👥 ${formatValue(playground.crowd_level)}`;
        sections.push(`
          <div style="margin-bottom: 16px;">
            <span class="chip">${crowdInfo}</span>
          </div>
        `);
      }

      // Special Features
      if (hasValue(playground.novelty_notes)) {
        sections.push(`
          <div style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; color: var(--accent); font-size: 14px;">✨ Special Features</h4>
            <div style="background: #0e141d; padding: 12px; border-radius: 8px; border: 1px solid #273143;">
              <p style="margin: 0; color: var(--ink); font-size: 14px; line-height: 1.4;">${playground.novelty_notes}</p>
            </div>
          </div>
        `);
      }

      // Last Verified (for admin context)
      if (hasValue(playground.last_verified) && state.adminAuthenticated) {
        const verifyDate = new Date(playground.last_verified).toLocaleDateString();
        sections.push(`
          <div style="margin-bottom: 16px;">
            <span class="chip" style="font-size: 11px; color: var(--muted);">📅 Verified: ${verifyDate}</span>
          </div>
        `);
      }

      return sections.join('');
    }

    // Pick random playground
    function pickRandomPlayground() {
      if (state.filteredPlaygrounds.length === 0) return;
      
      const random = state.filteredPlaygrounds[Math.floor(Math.random() * state.filteredPlaygrounds.length)];
      const {lat, lon} = normalizeLatLon(random);
      
      // Fly to location first
      state.map.flyTo([lat, lon], 16);
      
      // Find the marker for this playground and open its popup
      setTimeout(() => {
        const markerData = state.markers.find(m => m.playground.Playground_ID === random.Playground_ID);
        if (markerData) {
          markerData.marker.openPopup();
        }
      }, 500);
    }

    // Near Me functionality
    let nearMeState = {
      userLocation: null,
      searchLocation: null,
      nearbyPlaygrounds: [],
      distanceKm: 1.6, // Default to 20 min walk (~1.6km)
      userLocationMarker: null
    };

    const distanceOptions = [
      { label: '10 min walk', km: 0.8 },
      { label: '20 min walk', km: 1.6 },
      { label: '30 min walk', km: 2.4 },
      { label: '1 mile', km: 1.6 },
      { label: '2 miles', km: 3.2 },
      { label: '3 miles', km: 4.8 },
      { label: '5 miles', km: 8.0 }
    ];

    function findNearMe() {
      showNearMeModal();
    }

    function showNearMeModal() {
      qs('nearMeModal').style.display = 'block';
      qs('nearMeAddress').value = '';
      qs('distanceSlider').value = 2;
      updateDistanceLabel();
      qs('nearMeResults').style.display = 'none';
      qs('findNearbyPlaygrounds').disabled = true;
    }

    function hideNearMeModal() {
      qs('nearMeModal').style.display = 'none';
      if (nearMeState.userLocationMarker) {
        state.map.removeLayer(nearMeState.userLocationMarker);
        nearMeState.userLocationMarker = null;
      }
    }

    function updateDistanceLabel() {
      const sliderValue = parseInt(qs('distanceSlider').value);
      const option = distanceOptions[sliderValue];
      qs('distanceLabel').textContent = option.label;
      nearMeState.distanceKm = option.km;
    }

    async function useCurrentLocation() {
      if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
      }

      qs('useCurrentLocation').textContent = '🔄 Getting location...';
      qs('useCurrentLocation').disabled = true;

      navigator.geolocation.getCurrentPosition(
        position => {
          const { latitude, longitude } = position.coords;
          nearMeState.searchLocation = { lat: latitude, lon: longitude };
          qs('nearMeAddress').value = `${latitude.toFixed(4)}, ${longitude.toFixed(4)} (Your location)`;
          qs('findNearbyPlaygrounds').disabled = false;
          
          qs('useCurrentLocation').textContent = '📍 Use My Location';
          qs('useCurrentLocation').disabled = false;
        },
        error => {
          alert('Unable to get your location. Please make sure location services are enabled.');
          qs('useCurrentLocation').textContent = '📍 Use My Location';
          qs('useCurrentLocation').disabled = false;
        }
      );
    }

    async function geocodeAddress() {
      const address = qs('nearMeAddress').value.trim();
      if (!address) {
        alert('Please enter an address first.');
        return;
      }

      qs('geocodeAddress').textContent = '🔄 Finding...';
      qs('geocodeAddress').disabled = true;

      try {
        // Use Nominatim geocoding service (free, no API key needed)
        const query = encodeURIComponent(`${address}, New York, NY`);
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1&bounded=1&viewbox=-74.3,40.4,-73.7,40.9`);
        const results = await response.json();

        if (results.length > 0) {
          const result = results[0];
          nearMeState.searchLocation = { 
            lat: parseFloat(result.lat), 
            lon: parseFloat(result.lon) 
          };
          qs('nearMeAddress').value = result.display_name || address;
          qs('findNearbyPlaygrounds').disabled = false;
        } else {
          alert('Address not found. Please try a different address or use "Use My Location".');
        }
      } catch (error) {
        console.error('Geocoding error:', error);
        alert('Error finding address. Please try again or use "Use My Location".');
      }

      qs('geocodeAddress').textContent = '🔍 Find Address';
      qs('geocodeAddress').disabled = false;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Earth's radius in kilometers
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c; // Distance in kilometers
    }

    async function findNearbyPlaygrounds() {
      if (!nearMeState.searchLocation) {
        alert('Please set a location first.');
        return;
      }

      qs('findNearbyPlaygrounds').textContent = '🔄 Searching...';
      qs('findNearbyPlaygrounds').disabled = true;

      try {
        const allPlaygrounds = await playgroundDB.getAllPlaygrounds();
        console.log(`Searching ${allPlaygrounds.length} playgrounds from location:`, nearMeState.searchLocation);
        console.log(`Distance threshold: ${nearMeState.distanceKm}km`);
        
        const nearby = [];
        let debugCount = 0;

        for (const playground of allPlaygrounds) {
          const {lat, lon} = normalizeLatLon(playground);
          if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
            const distance = calculateDistance(
              nearMeState.searchLocation.lat,
              nearMeState.searchLocation.lon,
              lat, lon
            );
            
            // Debug first few playgrounds
            if (debugCount < 3) {
              console.log(`Playground: ${playground.Name}, coords: ${lat},${lon}, distance: ${distance.toFixed(2)}km`);
              debugCount++;
            }
            
            if (distance <= nearMeState.distanceKm) {
              nearby.push({
                ...playground,
                distance: distance,
                distanceText: distance < 1 ? 
                  `${Math.round(distance * 1000)}m` : 
                  `${distance.toFixed(1)}km`
              });
            }
          } else if (debugCount < 3) {
            console.log(`Invalid coordinates for playground: ${playground.Name}, lat: ${lat}, lon: ${lon}`);
            debugCount++;
          }
        }

        console.log(`Found ${nearby.length} nearby playgrounds`);
        
        // Sort by distance
        nearby.sort((a, b) => a.distance - b.distance);
        nearMeState.nearbyPlaygrounds = nearby;

        displayNearbyResults(nearby);
      } catch (error) {
        console.error('Error finding nearby playgrounds:', error);
        alert('Error searching for nearby playgrounds. Please try again.');
      }

      qs('findNearbyPlaygrounds').textContent = '🔍 Find Nearby Playgrounds';
      qs('findNearbyPlaygrounds').disabled = false;
    }

    function displayNearbyResults(playgrounds) {
      qs('nearbyCount').textContent = playgrounds.length;
      qs('nearMeResults').style.display = 'block';
      
      if (playgrounds.length === 0) {
        qs('nearbyList').innerHTML = '<div style="color:var(--muted);text-align:center;padding:20px;">No playgrounds found within the selected distance.</div>';
        return;
      }

      const html = playgrounds.map(p => {
        const accessColor = p.Accessible === 'Yes' ? 'var(--good)' : 
                           p.Accessible === 'Limited' ? '#f59e0b' : 'var(--bad)';
        const sensoryText = (p['Sensory-Friendly'] || '').toUpperCase() === 'Y' ? ' (Sensory-Friendly)' : '';
        
        return `
          <div style="border:1px solid #273143;border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;" 
               onclick="selectNearbyPlayground('${p.Playground_ID}', ${p.distance.toFixed(3)})">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
              <strong style="font-size:14px;">${p.Name || 'Unnamed Playground'}${sensoryText}</strong>
              <span style="color:var(--muted);font-size:12px;">${p.distanceText}</span>
            </div>
            <div style="color:var(--muted);font-size:12px;">${p.Location || 'Location not specified'}</div>
            <div style="margin-top:6px;font-size:11px;">
              <span style="color:${accessColor};">●</span> ${p.Accessible || 'Unknown'} accessibility
            </div>
          </div>
        `;
      }).join('');

      qs('nearbyList').innerHTML = html;
    }

    function selectNearbyPlayground(playgroundId, distance) {
      const playground = nearMeState.nearbyPlaygrounds.find(p => p.Playground_ID === playgroundId);
      if (playground) {
        const {lat, lon} = normalizeLatLon(playground);
        hideNearMeModal();
        state.map.flyTo([lat, lon], 16);
        setTimeout(() => showPlaygroundDetails(playground.Playground_ID), 500);
      }
    }

    function showNearbyOnMap() {
      if (nearMeState.nearbyPlaygrounds.length === 0) return;
      
      hideNearMeModal();
      
      // Add location marker if we have search location
      if (nearMeState.searchLocation && !nearMeState.userLocationMarker) {
        nearMeState.userLocationMarker = L.marker([nearMeState.searchLocation.lat, nearMeState.searchLocation.lon], {
          icon: L.divIcon({
            html: '<div style="background-color: #4fd1c5; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
            className: 'user-location-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).addTo(state.map);
        
        // Add distance circle to show search radius
        L.circle([nearMeState.searchLocation.lat, nearMeState.searchLocation.lon], {
          color: '#4fd1c5',
          fillColor: '#4fd1c5',
          fillOpacity: 0.1,
          weight: 2,
          radius: nearMeState.distanceKm * 1000 // Convert km to meters
        }).addTo(state.map);
      }
      
      // Highlight nearby playgrounds by filtering the visible ones
      const nearbyIds = new Set(nearMeState.nearbyPlaygrounds.map(p => p.Prop_ID));
      state.filteredPlaygrounds = nearMeState.nearbyPlaygrounds;
      
      // Update markers to show only nearby playgrounds
      addPlaygroundMarkers();
      
      // Fit map to show all nearby playgrounds and search location
      const bounds = L.latLngBounds();
      bounds.extend([nearMeState.searchLocation.lat, nearMeState.searchLocation.lon]);
      
      nearMeState.nearbyPlaygrounds.forEach(p => {
        const {lat, lon} = normalizeLatLon(p);
        if (lat && lon) bounds.extend([lat, lon]);
      });
      
      state.map.fitBounds(bounds, { padding: [20, 20] });
      
      // Show count in UI
      qs('count').textContent = `Found ${nearMeState.nearbyPlaygrounds.length} nearby playgrounds`;
    }

    // Database management functions
    let currentPlayground = null;

    async function updateFavoriteButton() {
      if (state.currentPlayground && qs('favoriteBtn')) {
        const isFav = await playgroundDB.isFavorite(state.currentPlayground.id);
        qs('favoriteBtn').textContent = isFav ? '💔 Remove from Favorites' : '❤️ Add to Favorites';
      }
    }

    async function toggleFavorite() {
      if (!state.currentPlayground) return;
      
      try {
        const isFavorite = await playgroundDB.isFavorite(state.currentPlayground.id);
        if (isFavorite) {
          await playgroundDB.removeFromFavorites(state.currentPlayground.id);
        } else {
          await playgroundDB.addToFavorites(state.currentPlayground.id);
        }
        updateFavoriteButton();
      } catch (e) {
        console.error('Error managing favorites:', e);
      }
    }

    // Load and initialize
    async function load() {
      try {
        console.log('Starting load process...');
        
        // Initialize map first
        console.log('Initializing map...');
        initMap();
        console.log('Map initialized');
        
        // Load playground data
        console.log('Loading playground data from database...');
        try {
          state.playgrounds = await playgroundDB.getAllPlaygrounds();
          console.log('Got', state.playgrounds.length, 'playgrounds from database');
          
          // Check if database has sprinkler data
          const withSprinklers = state.playgrounds.filter(p => p.has_sprinkler === true).length;
          console.log(`Database has ${withSprinklers} playgrounds with sprinklers`);
          
          if (withSprinklers === 0 && state.playgrounds.length > 0) {
            console.log('Database lacks sprinkler data, forcing reload from JSON...');
            state.playgrounds = [];
          }
        } catch (dbError) {
          console.warn('Database access failed, will load from JSON:', dbError);
          state.playgrounds = [];
        }
        
        if (state.playgrounds.length === 0) {
          console.log('Database empty, loading from JSON...');
          qs('loading').textContent = 'Loading playground data from JSON...';
          
          try {
            const res = await fetch('./Playgrounds_Sprinkler_Info.json');
            console.log('JSON fetch response:', res.status);
            
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const data = await res.json();
            console.log('JSON data loaded, length:', data.length);
            
            // Check sprinkler data in JSON
            const jsonWithSprinklers = data.filter(p => p.has_sprinkler === true).length;
            console.log(`JSON has ${jsonWithSprinklers} playgrounds with sprinklers`);
            if (data.length > 0) {
              console.log('First JSON playground sample:', {
                name: data[0].Name,
                has_sprinkler: data[0].has_sprinkler,
                sprinkler_status: data[0].sprinkler_status
              });
            }
            
            const normalizedData = data.map(p => ({...p})).filter(p => p && p.Name);
            console.log('Normalized data length:', normalizedData.length);
            
            // If database fails, just use the JSON data directly
            try {
              console.log('Initializing database with JSON data...');
              await playgroundDB.initialize(normalizedData);
              state.playgrounds = await playgroundDB.getAllPlaygrounds();
              console.log('Database initialized, got', state.playgrounds.length, 'playgrounds');
            } catch (dbError) {
              console.warn('Database initialization failed, using JSON data directly:', dbError);
              state.playgrounds = normalizedData;
            }
          } catch (fetchError) {
            console.error('Failed to fetch JSON data:', fetchError);
            throw fetchError;
          }
        }
        
        state.filteredPlaygrounds = [...state.playgrounds];
        console.log('Adding markers to map...');
        addPlaygroundMarkers();
        
        qs('loading').style.display = 'none';
        qs('count').textContent = `${state.playgrounds.length} playgrounds loaded`;
        console.log('Load process completed successfully');
        
      } catch (e) {
        qs('loading').textContent = 'Error loading playground data: ' + e.message;
        console.error('Load error:', e);
      }
    }

    // Check for admin authentication on load
    if (checkAdminAuth()) {
      state.adminAuthenticated = true;
    }

    // Mobile menu toggle functionality
    function toggleMobileMenu() {
      const content = qs('sidebar-content');
      const hamburger = qs('hamburger');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        hamburger.classList.add('active');
      } else {
        content.classList.add('collapsed');
        hamburger.classList.remove('active');
      }
    }

    // Initialize mobile menu as collapsed on small screens
    function initMobileMenu() {
      if (window.innerWidth <= 768) {
        qs('sidebar-content').classList.add('collapsed');
        qs('hamburger').classList.remove('active');
      } else {
        qs('sidebar-content').classList.remove('collapsed');
        qs('hamburger').classList.remove('active');
      }
    }

    // Event listeners
    qs('applyFilters').addEventListener('click', applyFilters);
    qs('pickRandom').addEventListener('click', pickRandomPlayground);
    qs('findMe').addEventListener('click', findNearMe);
    qs('mobileMenuToggle').addEventListener('click', toggleMobileMenu);
    qs('closeDetails').addEventListener('click', () => {
      qs('detailsPanel').classList.remove('visible');
    });

    // Admin panel event listeners
    qs('adminClose').addEventListener('click', () => toggleAdminMode());
    qs('adminLogout').addEventListener('click', () => logoutAdmin());
    qs('addPlayground').addEventListener('click', () => showAddPlaygroundModal());
    qs('managePlaygrounds').addEventListener('click', () => showManagePlaygroundsModal());
    qs('editPlaygroundInfo').addEventListener('click', () => showPlaygroundInfoEditor());
    qs('addReview').addEventListener('click', () => showAddReviewModal());
    qs('manageReviews').addEventListener('click', () => showReviewManager());
    
    // Database management event listeners
    qs('addFavorite').addEventListener('click', () => addToFavorites());
    qs('viewFavorites').addEventListener('click', () => viewFavorites());
    qs('exportData').addEventListener('click', () => exportData());
    qs('showStats').addEventListener('click', () => showStats());
    qs('upgradeSchema').addEventListener('click', () => upgradeSchema());
    qs('resetDatabase').addEventListener('click', () => resetDatabase());

    // Review modal event listeners
    qs('closeReviewModal').addEventListener('click', hideAddReviewModal);
    qs('cancelReview').addEventListener('click', hideAddReviewModal);
    qs('saveReview').addEventListener('click', saveReview);

    // Playground modal event listeners
    qs('closePlaygroundModal').addEventListener('click', hidePlaygroundModal);
    qs('cancelPlayground').addEventListener('click', hidePlaygroundModal);
    qs('savePlayground').addEventListener('click', savePlayground);

    // Playground management event listeners
    qs('closeManagePlaygrounds').addEventListener('click', hideManagePlaygroundsModal);
    qs('searchPlaygrounds').addEventListener('click', searchPlaygrounds);
    qs('clearSearch').addEventListener('click', clearPlaygroundSearch);
    qs('playgroundSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchPlaygrounds();
      }
    });

    // Near Me modal event listeners
    qs('closeNearMe').addEventListener('click', hideNearMeModal);
    qs('cancelNearMe').addEventListener('click', hideNearMeModal);
    qs('useCurrentLocation').addEventListener('click', useCurrentLocation);
    qs('geocodeAddress').addEventListener('click', geocodeAddress);
    qs('findNearbyPlaygrounds').addEventListener('click', findNearbyPlaygrounds);
    qs('showOnMap').addEventListener('click', showNearbyOnMap);
    qs('distanceSlider').addEventListener('input', updateDistanceLabel);
    qs('nearMeAddress').addEventListener('input', (e) => {
      qs('findNearbyPlaygrounds').disabled = e.target.value.trim() === '';
    });
    qs('nearMeAddress').addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !qs('findNearbyPlaygrounds').disabled) {
        geocodeAddress();
      }
    });

    // Playground Info Editor event listeners
    qs('closePlaygroundInfo').addEventListener('click', hidePlaygroundInfoEditor);
    qs('cancelPlaygroundInfo').addEventListener('click', hidePlaygroundInfoEditor);
    qs('searchPlaygroundInfo').addEventListener('click', searchPlaygroundsForInfoEdit);
    qs('playgroundInfoSelect').addEventListener('change', selectPlaygroundForInfoEdit);
    qs('playgroundInfoForm').addEventListener('submit', savePlaygroundInfo);
    qs('playgroundInfoSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchPlaygroundsForInfoEdit();
      }
    });

    // Star rating event listeners
    document.querySelectorAll('.star-rating').forEach(star => {
      star.addEventListener('click', (e) => {
        e.preventDefault();
        const rating = parseInt(e.target.dataset.rating);
        qs('reviewRating').value = rating;
        updateStarDisplay(rating);
      });
    });

    // Review form submission
    qs('reviewForm').addEventListener('submit', (e) => {
      e.preventDefault();
      saveReview();
    });

    // Keyboard shortcut for admin mode: Ctrl+Shift+A
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        e.preventDefault();
        toggleAdminMode();
      }
    });

    // Favorite button handler (delegated)
    document.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'favoriteBtn') {
        toggleFavorite();
      }
    });

    // Initialize star display
    updateStarDisplay(5);

    // Initialize mobile menu
    initMobileMenu();
    
    // Handle window resize for mobile menu
    window.addEventListener('resize', initMobileMenu);

    // Load everything
    load();
  </script>
</body>
</html>